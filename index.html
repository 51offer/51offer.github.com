<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>51offer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="每周分享博客">
<meta property="og:type" content="website">
<meta property="og:title" content="51offer">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="51offer">
<meta property="og:description" content="每周分享博客">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="51offer">
<meta name="twitter:description" content="每周分享博客">
  
    <link rel="alternative" href="/atom.xml" title="51offer" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">移动组团队</a></h1>
		</hgroup>

		
		<p class="header-subtitle">MobileBlogs</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/51offer" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/p/1006062608078012/home" title="weibo">weibo</a>
					        
								<a class="mail" target="_blank" href="/ming.z@51offer.com" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Chrome/" style="font-size: 10px;">Chrome</a> <a href="/tags/JUnit4/" style="font-size: 10px;">JUnit4</a> <a href="/tags/Playground/" style="font-size: 10px;">Playground</a> <a href="/tags/blog-tools-ci/" style="font-size: 10px;">blog, tools, ci</a> <a href="/tags/express/" style="font-size: 10px;">express</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/javaScript/" style="font-size: 10px;">javaScript</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/phython/" style="font-size: 10px;">phython</a> <a href="/tags/shell/" style="font-size: 20px;">shell</a> <a href="/tags/tablayout/" style="font-size: 10px;">tablayout</a> <a href="/tags/weui/" style="font-size: 10px;">weui</a> <a href="/tags/博客/" style="font-size: 10px;">博客</a> <a href="/tags/同步异步/" style="font-size: 10px;">同步异步</a> <a href="/tags/坑/" style="font-size: 10px;">坑</a> <a href="/tags/开发效率/" style="font-size: 10px;">开发效率</a> <a href="/tags/效率/" style="font-size: 10px;">效率</a> <a href="/tags/游戏/" style="font-size: 10px;">游戏</a> <a href="/tags/研发杂谈/" style="font-size: 10px;">研发杂谈</a> <a href="/tags/线程/" style="font-size: 10px;">线程</a> <a href="/tags/网站/" style="font-size: 10px;">网站</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.tomatopeter.com/">tomatopeter&#39;s blog&#39;</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://ioi.im/">ming.z&#39;s blog</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">我们是一群爱折腾的技术宅，立志在留学行业做些好玩的事。如果你相信技术拥有强大的力量，有很多有趣的念头不知在何处能实践，不妨加入我们一起切磋。。。</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">移动组团队</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">移动组团队</h1>
			</hgroup>
			
			<p class="header-subtitle">MobileBlogs</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/51offer" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/p/1006062608078012/home" title="weibo">weibo</a>
			        
						<a class="mail" target="_blank" href="/ming.z@51offer.com" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap">
  
    <article id="post-移动周分享-第61期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/29/移动周分享-第61期/" class="article-date">
  	<time datetime="2016-07-29T14:30:00.000Z" itemprop="datePublished">2016-07-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/29/移动周分享-第61期/">移动周分享-第61期</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="CloudKit初探_-_刘康">CloudKit初探 - 刘康</h2><h3 id="什么是CloudKit">什么是CloudKit</h3><ul>
<li>iCloud</li>
<li>Documents</li>
<li>iCloud Drive</li>
<li>CloudKit</li>
</ul>
<h3 id="CloudKit_基础对象类型">CloudKit 基础对象类型</h3><ul>
<li><p><code>CKContainer</code>: Containers 就像应用运行的沙盒一样，一个应用只能访问自己沙盒中的内容而不能访问其他应用的。Containers 就是最外层容器，每个应用有且仅有一个属于自己的 container。</p>
</li>
<li><p><code>CKDatabase</code>: Database 即数据库，私有数据库用来存储敏感信息，比如说用户的性别年龄等，用户只能访问自己的私有数据库。应用也有一个公开的数据库来存储公共信息，例如你在构建一个基于地理位置的应用，那么地理位置信息就应该存储在公共数据库里以便所有用户都能访问到。</p>
</li>
<li><p><code>CKRecord</code>: 即数据库中的一条数据记录。CloudKit 使用 record 通过 key-value 结构来存储结构化数据。关于键值存储，目前值的架构支持 NSString、NSNumber、NSData、NSDate、CLLocation，和 CKReference、CKAsset（这两个下面我们会说明），以及存储以上数据类型的数组。</p>
</li>
<li><p><code>CKRecordZone</code>: Record 不是以零散的方式存在于 database 之中的，它们位于 record zones 里。每个应用都有一个 default record zone，你也可以有自定义的 record zone。</p>
</li>
<li><p><code>CKRecordIdentifier</code>: 是一条 record 的唯一标识，用于确定该 record 在数据库中的唯一位置。</p>
</li>
<li><p><code>CKReference</code>: Reference 一种引用关系。以地理位置签到应用为例，每个地理位置可以包含很多用户在该位置的签到，那么位置与签到之间就形成了这样一种包含式的从属关系。</p>
</li>
<li><p><code>CKAsset</code>: 即资源文件，例如二进制文件。还是以签到应用为例，用户签到时可能还包含一张照片，那么这张照片就会以 asset 形式存储起来。</p>
</li>
</ul>
<h3 id="有哪些Api（Diary_Demo）">有哪些Api（Diary Demo）</h3><h4 id="增">增</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">updateRecord</span><span class="params">(diary: Diary, record: CKRecord)</span></span> &#123;</span><br><span class="line">    </span><br><span class="line">    record.setObject(diary.content, forKey: <span class="string">"Content"</span>)</span><br><span class="line">    </span><br><span class="line">    record.setObject(diary.created_at, forKey: <span class="string">"Created_at"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> location = diary.location &#123;</span><br><span class="line">        record.setObject(location, forKey: <span class="string">"Location"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> title = diary.title &#123;</span><br><span class="line">        record.setObject(title, forKey: <span class="string">"Title"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    record.setObject(diary.id, forKey: <span class="string">"id"</span>)</span><br><span class="line">    </span><br><span class="line">    privateDB.saveRecord(record, completionHandler: &#123; (newDiary, error) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">        </span><br><span class="line">        <span class="built_in">debugPrint</span>(<span class="string">"Diary Updated"</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">            <span class="built_in">debugPrint</span>(<span class="string">"error <span class="subst">\(error.description)</span>"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="删">删</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">deleteCloudRecord</span><span class="params">(record: CKRecord)</span></span> &#123;</span><br><span class="line">    privateDB.deleteRecordWithID(record.recordID) &#123; (recordID, error) -&gt; <span class="type">Void</span> <span class="keyword">in</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"Delete <span class="subst">\(recordID?.recordName)</span> <span class="subst">\(error?.description)</span>"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="改">改</h4><p>查询 -&gt; 修改 -&gt; 更新</p>
<h4 id="查">查</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">fetchCloudRecordWithTitle</span><span class="params">(title: String , complete: <span class="params">([CKRecord]?)</span></span></span> -&gt; <span class="type">Void</span>) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> predicate = <span class="type">NSPredicate</span>(format: <span class="string">"Title == %@"</span>, title)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> query = <span class="type">CKQuery</span>(recordType: <span class="string">"Diary"</span>,</span><br><span class="line">                        predicate: predicate )</span><br><span class="line">    </span><br><span class="line">    privateDB.performQuery(query, inZoneWithID: <span class="literal">nil</span>) &#123;</span><br><span class="line">        results, error <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> results = results &#123;</span><br><span class="line">            complete(results)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            complete(<span class="literal">nil</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="碰到的问题(踩到的坑)">碰到的问题(踩到的坑)</h3><ol>
<li><code>Saving CloudKit Record “Not Authenticated” (9/1002)“ ”This request requires an authenticated account</code><br>原因：使用模拟器或者设备没有启用iCloud</li>
<li><code>Couldn&#39;t get container configuration from the server for container</code><br>原因：container’s identifier错误，可能是使用默认值，也可能是与代码里初始化container时的identifier不一致；<br>另外，需要与开发者中心<code>Certificates, Identifiers &amp; Profiles</code>的iCloud Containers保持一致。<strong>需要5分钟左右才可以使用</strong></li>
<li><code>Invalid Arguments(12/2015); server message = Field &#39;___recordID&#39; is not marked queryable</code><br>原因：未设置<code>Metadata Indexes</code>.需要前往CloudKit Dashboard -&gt; Record Types -&gt; Metedata Indexes设置</li>
</ol>
<h3 id="收费">收费</h3><p>等不及要试试 CloudKit 了？它能让你从编写服务端代码、监控服务器压力、长期维护大量的 CDN、租用服务器等等等等的事情中解脱出来。等等！CloudKit 怎么收费呢，会很贵吗？答案是：免费。目前苹果允许你使用 CloudKit 存储 10 GB 资源，100 M 数据库存储，每天 2 GB 流量；当你的用户数量增加的时候，这些免费额度也相应地增加到 1 PB 存储、10 TB 数据库存储，以及每天 200 TB 流量。</p>
<h3 id="参考">参考</h3><p><a href="https://developer.apple.com/library/ios/documentation/DataManagement/Conceptual/CloudKitQuickStart/EnablingiCloudandConfiguringCloudKit/EnablingiCloudandConfiguringCloudKit.html#//apple_ref/doc/uid/TP40014987-CH2-SW1" target="_blank" rel="external">https://developer.apple.com/library/ios/documentation/DataManagement/Conceptual/CloudKitQuickStart/EnablingiCloudandConfiguringCloudKit/EnablingiCloudandConfiguringCloudKit.html#//apple_ref/doc/uid/TP40014987-CH2-SW1</a></p>
<p><a href="https://icloud.developer.apple.com/dashboard" target="_blank" rel="external">https://icloud.developer.apple.com/dashboard</a></p>
<p><a href="http://nshipster.cn/cloudkit/" target="_blank" rel="external">http://nshipster.cn/cloudkit/</a></p>
<h3 id="通用链接（_Universal_Links_）-_杨志平">通用链接（ Universal Links ）- 杨志平</h3><p>@(iOS)[universal links, 通用链接]</p>
<blockquote>
<ul>
<li>通过唯一的网址, 就可以链接一个特定的视图到你的 APP 里面, 不需要特别的 schema</li>
<li>不再需要JavaScript检查平台，跳转也不需要js去做特定处理</li>
<li>比scheme更灵活更安全的匹配URL跳转</li>
</ul>
<p>注意：不能使用模拟器调试</p>
</blockquote>
<p><img src="https://s3-eu-west-1.amazonaws.com/hoko-blog/universal_links.png" alt="image"></p>
<blockquote>
<p>工作原理：When the app is installed, the system downloads and verifies the site association file for each of its associated domains. If the verification is successful, the app is associated with the domain.</p>
</blockquote>
<h4 id="Configure_your_file_server">Configure your file server</h4><ul>
<li><a href="https://api-pre.51offer.com/apple-app-site-association" target="_blank" rel="external">我们的根路径配置文件</a></li>
<li><a href="https://branch.io/resources/universal-links/" target="_blank" rel="external">根路径配置有效性验证</a><h5 id="要求如下：">要求如下：</h5><blockquote>
<p>Alright! So you have your signed apple-app-site-association file. Now you just need to configure your file server to host this for you. There are a few caveats:</p>
</blockquote>
</li>
<li>It must be sent with the header ‘application/pkcs7-mime’</li>
<li>It must be sent from the endpoint youdomain.com/apple-app-site-association</li>
<li>It must return a 200 http code.</li>
</ul>
<blockquote>
<p>We set up the one for all Branch integrated apps using our Node+Express link servers. Here’s the code we used in case that’s helpful:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> aasa = fs.readFileSync(__dirname + <span class="string">'/static/apple-app-site-association'</span>);</span><br><span class="line">app.get(<span class="string">'/apple-app-site-association'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">     res.set(<span class="string">'Content-Type'</span>, <span class="string">'application/pkcs7-mime'</span>);</span><br><span class="line">     res.status(<span class="number">200</span>).send(aasa);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>可以从原有的scheme过渡过来<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application openURL:(<span class="built_in">NSURL</span> *)url sourceApplication:(<span class="built_in">NSString</span> *)sourceApplication annotation:(<span class="keyword">id</span>)annotation &#123;</span><br><span class="line">    [<span class="keyword">self</span> handleRouting:url];</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)application:(<span class="built_in">UIApplication</span> *)application continueUserActivity:(<span class="built_in">NSUserActivity</span> *)userActivity restorationHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSArray</span> *))restorationHandler &#123;</span><br><span class="line">    <span class="keyword">if</span> ([userActivity<span class="variable">.activityType</span> isEqualToString:<span class="built_in">NSUserActivityTypeBrowsingWeb</span>]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> handleRouting:userActivity<span class="variable">.webpageURL</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)handleRouting:(<span class="built_in">NSURL</span> *)url &#123;</span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><strong>视频</strong>优先推荐<br><a href="https://developer.apple.com/videos/play/wwdc2015/509/" target="_blank" rel="external">https://developer.apple.com/videos/play/wwdc2015/509/</a></p>
<p><strong>优秀博客</strong><br><a href="https://blog.branch.io/how-to-setup-universal-links-to-deep-link-on-apple-ios-9" target="_blank" rel="external">https://blog.branch.io/how-to-setup-universal-links-to-deep-link-on-apple-ios-9</a></p>
<p><a href="https://blog.branch.io/ios-9.2-deep-linking-guide-transitioning-to-universal-links" target="_blank" rel="external">https://blog.branch.io/ios-9.2-deep-linking-guide-transitioning-to-universal-links</a></p>
<p><a href="http://blog.hokolinks.com/how-to-implement-apple-universal-links-on-ios-9/" target="_blank" rel="external">http://blog.hokolinks.com/how-to-implement-apple-universal-links-on-ios-9/</a></p>
<p><strong>可能出现的bug</strong>（巨坑，也可能是配置问题）<br><a href="http://stackoverflow.com/questions/32751225/ios9-universal-links-does-not-work" target="_blank" rel="external">http://stackoverflow.com/questions/32751225/ios9-universal-links-does-not-work</a></p>
<h2 id="结合实例介绍_nginx_配置_-_曾铭">结合实例介绍 nginx 配置 - 曾铭</h2><h3 id="默认配置">默认配置</h3><p>DNS, nginx, tomcat, application</p>
<p><a href="https://api-pre.51offer.com/mobile/user/login" target="_blank" rel="external">https://api-pre.51offer.com/mobile/user/login</a></p>
<p>DNS: api-pre.51offer.com(host) -&gt; IP(nginx)</p>
<p>nginx: IP(nginx):80 -&gt; IP(tomcat):8080</p>
<p>tomcat: /mobile</p>
<p>application: /user/login (controller, function)</p>
<p>看 nginx 配置</p>
<h3 id="两个问题">两个问题</h3><h4 id="调试_Universal_Link">调试 Universal Link</h4><p><a href="https://api-pre.51offer.com/xyz.html" target="_blank" rel="external">https://api-pre.51offer.com/xyz.html</a><br><a href="https://api-pre.51offer.com/apple-site-app-config" target="_blank" rel="external">https://api-pre.51offer.com/apple-site-app-config</a></p>
<ul>
<li>调整 tomcat content_path <a href="http://gitlab.51offer.inner/tool/tool-tms/commit/24b8c6f69ea0029b8cea8b7cbc46f3c2f355271d" target="_blank" rel="external">http://gitlab.51offer.inner/tool/tool-tms/commit/24b8c6f69ea0029b8cea8b7cbc46f3c2f355271d</a></li>
<li>调整 application 静态文件路径</li>
<li>改 header: nginx</li>
</ul>
<h3 id="线上_fixbug">线上 fixbug</h3><p><a href="http://www.51offer.com/aboutus/server.html?in_app=1" target="_blank" rel="external">http://www.51offer.com/aboutus/server.html?in_app=1</a></p>
<p>api.51offer.com</p>
<p><a href="https://api.51offer.com/aboutus/server.html?in_app=1" target="_blank" rel="external">https://api.51offer.com/aboutus/server.html?in_app=1</a><br><a href="https://api.51offer.com/aboutus/protocol.html?in_app=1" target="_blank" rel="external">https://api.51offer.com/aboutus/protocol.html?in_app=1</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-移动周分享-第60期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/22/移动周分享-第60期/" class="article-date">
  	<time datetime="2016-07-22T14:45:00.000Z" itemprop="datePublished">2016-07-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/22/移动周分享-第60期/">移动周分享-第60期</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="微信-支付宝-银联支付对比_-_王胜">微信-支付宝-银联支付对比 - 王胜</h2><h3 id="微信支付"><a href="https://pay.weixin.qq.com" target="_blank" rel="external">微信支付</a></h3><h4 id="业务流程"><a href="https://pay.weixin.qq.com/wiki/doc/api/app/app.php?chapter=8_3" target="_blank" rel="external">业务流程</a></h4><p><img src="https://pay.weixin.qq.com/wiki/doc/api/img/chapter8_3_1.png" alt="pay-weixin-timeline"></p>
<h3 id="支付宝"><a href="https://open.alipay.com" target="_blank" rel="external">支付宝</a></h3><h4 id="业务流程-1"><a href="https://doc.open.alipay.com/doc2/detail.htm?spm=a219a.7629140.0.0.8NhMga&amp;treeId=59&amp;articleId=103658&amp;docType=1" target="_blank" rel="external">业务流程</a></h4><p><img src="https://img.alicdn.com/top/i1/LB1n8NYKVXXXXbbXpXXXXXXXXXX" alt="pay-alipay-timeline"></p>
<h3 id="银联"><a href="https://open.unionpay.com" target="_blank" rel="external">银联</a></h3><h4 id="业务流程-2"><a href="https://open.unionpay.com/ajweb/product/detail?id=3" target="_blank" rel="external">业务流程</a></h4><p><img src="https://open.unionpay.com/upload/image/1416394316921062523.png" alt="pay-unionpay-timeline"></p>
<h3 id="结论">结论</h3><table>
<thead>
<tr>
<th style="text-align:left">支付平台</th>
<th style="text-align:left">流程图</th>
<th style="text-align:left">文档</th>
<th style="text-align:left">接口设计</th>
<th style="text-align:left">demo</th>
<th style="text-align:left">测试相关</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">微信</td>
<td style="text-align:left">&hearts;&hearts;&hearts;&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;&hearts;&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;&hearts;&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;&hearts;&hearts;</td>
</tr>
<tr>
<td style="text-align:left">支付宝</td>
<td style="text-align:left">&hearts;&hearts;&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;</td>
</tr>
<tr>
<td style="text-align:left">银联</td>
<td style="text-align:left">&hearts;&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;</td>
<td style="text-align:left">&hearts;&hearts;&hearts;&hearts;</td>
</tr>
</tbody>
</table>
<p>说明：</p>
<ul>
<li><p>路程图</p>
<p>从全面性和完整性看，微信 &gt; 支付宝 &gt; 银联</p>
</li>
<li><p>文档：</p>
<p>微信更简洁，清晰，完整；其他两家还是相对传统的风格，尤其是银联</p>
</li>
<li><p>接口设计：</p>
<p>微信的接口设计更简洁灵活易用，支付宝次之，银联的字段说明另类。</p>
</li>
<li><p>demo:</p>
<p>微信demo还算清楚，但是美中不足项目编码非utf-8，还得用Notepad++才正确编码显示；支付宝和银联的demo看起来晕。</p>
</li>
<li><p>测试：</p>
<p>微信的测试环境是通过添加沙箱sandbox路径实现；另外，微信提供了测试用例，赞一个。支付宝没有看到有测试环境。银联在sdk的API参数中，提供了环境参数设置。</p>
</li>
</ul>
<h2 id="iOS响应者链与hit-testing_-_刘康">iOS响应者链与hit-testing - 刘康</h2><p>今天我们来探索一下，当我们点击微信扫一扫就能打开扫码视图，当我们点击屏幕的时候。背后发生了些什么？</p>
<p>当用户通过以上方式触发一个事件时，会将相应的事件对象添加到<code>UIApplication</code>的事件队列中。<code>UIApplication</code>会循环的从队列中拿出第一个事件来处理。首先将该事件分发给<code>UIApplication</code>的主窗口对象(<strong>KeyWindow</strong>)，然后由主窗口决定如何将事件交给最合适的响应者(<code>UIResponder</code>)来处理取决于事件的类型。这里主要分两种情况：</p>
<h3 id="触摸事件">触摸事件</h3><p><code>UIApplication</code>通过一个触摸检测来决定最合适来处理该事件的响应者，一般情况下，这个响应者是<code>UIView</code>对象。<br>对于触摸事件，window对象会尝试着首先将事件传递给触摸事件发生点得View。这个View被视为“<code>命中测试view</code>” (hit-test view)。</p>
<h3 id="手势和远程控制事件">手势和远程控制事件</h3><p>UIApplication寻找UIWindow中的第一响应者。找到第一响应者(<code>The First Responder</code>)后，会将该事件对象派发给该响应者以便处理。</p>
<h3 id="事件传递响应链">事件传递响应链</h3><p>最终所有的事件响应路径都是为了去寻找那个能够响应并处理该事件的对象。因此，UIkit会首先发送该事件给最适合处理该事件的对象。对于触摸事件，这个最适合处理的对象就是 hit-test view既“命中测试view”,并且对于其它事件，这个对象就是“第一响应者”。</p>
<h4 id="命中测试返回触摸事件发生点的view">命中测试返回触摸事件发生点的view</h4><p>系统检测到手指触摸(<code>Touch</code>)操作时会将其放入当前活动Application的事件队列，UIApplication会从事件队列中取出触摸事件并传递给<code>key window</code>处理,window对象首先会使用<code>hitTest:withEvent:</code>方法寻找此次Touch操作初始点所在的视图(View),即需要将触摸事件传递给其处理的视图:</p>
<p>为了去阐明这个过程，假设用户触摸 view E 如图所示。iOS会以这样的顺序去寻找命中测试view通过检测所有的子view.<br><img src="http://oaclergq7.bkt.clouddn.com/hit-testing.png" alt="Alt text"></p>
<ol>
<li><p>触摸点是否在view A的边界之内，如果是它会检测子视图B和C.</p>
</li>
<li><p>触摸点不在view B的边界之内，但是它在view C的边界之内，因此它就去检测C的子视图D和E。</p>
</li>
<li><p>触摸事件不在view D的边界之内，但是在view E的边界之内。view E是整个包含触摸事件的view层级中最底端的view，因此view E就名正言顺的成为了“命中测试view”。</p>
</li>
</ol>
<p><strong>例外</strong><br>不满足一下三个条件的Responder是不能接收触摸事件的：</p>
<ul>
<li>不允许交互：userInteractionEnabled = NO</li>
<li>隐藏：如果把父控件隐藏，那么子控件也会隐藏，隐藏的控件不能接受事件</li>
<li>透明度：如果设置一个控件的透明度&lt;0.01，会直接影响子控件的透明度。alpha：0.0~0.01为透明。</li>
</ul>
<p><strong>注意点</strong><br>一个触摸事件对象将会被关联于命中测试view的整个生命周期，即使这个触摸后来移到了view的边界之外。</p>
<h3 id="实例">实例</h3><ol>
<li>在此例子中button,scrollview同为topView的子视图，但scrollview覆盖在button之上，这样在在button上的触摸操作返回的hit-test view为scrollview,button无法响应，可以修改topView的hitTest:withEvent:方法如下:</li>
</ol>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="type">UIView</span> *)hitTest:(<span class="type">CGPoint</span>)point withEvent:(<span class="type">UIEvent</span> *)event</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">UIView</span>* <span class="literal">result</span> = [super hitTest:point withEvent:event];</span><br><span class="line">    <span class="type">CGPoint</span> buttonPoint = [_checkedButton convertPoint:point fromView:self];</span><br><span class="line">    <span class="keyword">if</span> ([_checkedButton pointInside:buttonPoint withEvent:event]) &#123;</span><br><span class="line">        <span class="keyword">return</span> _checkedButton;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>放弃自身响应，让子视图去响应事件：</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UIView</span>*)hitTest:(<span class="built_in">CGPoint</span>)point withEvent:(<span class="built_in">UIEvent</span> *)event&#123;</span><br><span class="line">    <span class="comment">//当事件是传递给此View内部的子View时，让子View自己捕获事件，如果是传递给此View自己时，放弃事件捕获</span></span><br><span class="line">    <span class="built_in">UIView</span>* __tmpView = [<span class="keyword">super</span> hitTest:point withEvent:event];</span><br><span class="line">    <span class="keyword">if</span> (__tmpView == <span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> __tmpView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>扩大按钮可点击区域：</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">UIView</span>*)hitTest:(<span class="built_in">CGPoint</span>) point withEvent:(<span class="built_in">UIEvent</span>*) event</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">CGRect</span> rect = [<span class="keyword">self</span> enlargedRect];</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">CGRectEqualToRect</span>(rect, <span class="keyword">self</span><span class="variable">.bounds</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> hitTest:point withEvent:event];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">CGRectContainsPoint</span>(rect, point) ? <span class="keyword">self</span> : <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="加速库在数学运算中的使用_-_杨志平">加速库在数学运算中的使用 - 杨志平</h2><p>@(iOS)[加速|Accelerate]</p>
<blockquote>
<p>除了加减乘除外还有好多好多数学运算需要我们处理，但我们很多都没有用到，感觉low爆了</p>
</blockquote>
<h3 id="Apple：加速框架文档"><a href="https://developer.apple.com/library/ios/documentation/Accelerate/Reference/vDSPRef/index.html#//apple_ref/doc/uid/TP40009464-CH13-12342" target="_blank" rel="external">Apple：加速框架文档</a></h3><blockquote>
<p>Any time you’ve got to make some numbers happen, it’s probably worth it to consider using Accelerate</p>
</blockquote>
<h3 id="示例">示例</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 模拟随机数据</span></span><br><span class="line"><span class="keyword">var</span> doubles  = (<span class="number">0</span>...<span class="number">10000</span>).<span class="built_in">map</span> &#123;<span class="number">_</span> <span class="keyword">in</span> <span class="type">Double</span>(arc4random()%<span class="number">10000</span>)&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 求和</span></span><br><span class="line"><span class="comment">// 常见的加法求和</span></span><br><span class="line"><span class="keyword">let</span> reduceSum = doubles.<span class="built_in">reduce</span>(<span class="number">0</span>) &#123; $<span class="number">0</span>+$<span class="number">1</span> &#125;</span><br><span class="line"><span class="comment">// Accelerate 封装</span></span><br><span class="line"><span class="keyword">let</span> accSum = sum(doubles)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 求最大值（最小值也一样）</span></span><br><span class="line"><span class="keyword">let</span> maxOfArr = <span class="built_in">max</span>(doubles)</span><br><span class="line"><span class="keyword">let</span> maxOfArr2 = doubles.<span class="built_in">sort</span>(&gt;).first</span><br><span class="line"></span><br><span class="line"><span class="comment">// 平均值,哈哈大数据统计，可以测试准确率</span></span><br><span class="line"><span class="keyword">let</span> meanValue = mean(doubles)</span><br><span class="line"><span class="keyword">let</span> meanValue2 = doubles.<span class="built_in">reduce</span>(<span class="number">0</span>) &#123; $<span class="number">0</span> + $<span class="number">1</span>/<span class="type">Double</span>(doubles.<span class="built_in">count</span>) &#125;</span><br><span class="line">meanValue2</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向量加减乘积</span></span><br><span class="line"><span class="keyword">let</span> vector1 = [<span class="number">2</span>,<span class="number">4</span>,<span class="number">5</span>] <span class="keyword">as</span> [<span class="type">Double</span>]</span><br><span class="line"><span class="keyword">let</span> vector2 = [<span class="number">3</span>,<span class="number">5</span>,<span class="number">2</span>] <span class="keyword">as</span> [<span class="type">Double</span>]</span><br><span class="line"><span class="keyword">let</span> sumArrs = add(vector1, y: vector2)</span><br></pre></td></tr></table></figure>
<p>耗时上对比是不是<code>reduce，map</code>等系统的高阶函数被<code>“加速库”</code>秒了，但使用上貌似reduce，map是比较灵活的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">let</span> newReduceSum = (<span class="number">0</span>...<span class="number">1000</span>).reduce(<span class="number">0</span>) &#123; <span class="variable">$0</span>+<span class="variable">$1</span> &#125;</span><br><span class="line">newReduceSum</span><br></pre></td></tr></table></figure></p>
<h3 id="其他计算的一点的应用">其他计算的一点的应用</h3><blockquote>
<p>函数混合示例: 使用中文变量😄</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> 函数点阵密度 = <span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> 频率<span class="number">1</span> = <span class="number">4.0</span></span><br><span class="line"><span class="keyword">let</span> 相位<span class="number">1</span> = <span class="number">0.0</span></span><br><span class="line"><span class="keyword">let</span> 幅度<span class="number">1</span> = <span class="number">1.0</span></span><br><span class="line"><span class="keyword">let</span> 正弦函数<span class="number">1</span> = (<span class="number">0</span>..&lt;函数点阵密度).<span class="built_in">map</span> &#123;</span><br><span class="line">    幅度<span class="number">1</span> * sin(<span class="number">2.0</span> * <span class="type">M_PI</span> / <span class="type">Double</span>(函数点阵密度) * <span class="type">Double</span>($<span class="number">0</span>) * 频率<span class="number">1</span> + 相位<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> 频率<span class="number">2</span> = <span class="number">1.0</span></span><br><span class="line"><span class="keyword">let</span> 相位<span class="number">2</span> = <span class="type">M_PI</span> / <span class="number">2.0</span></span><br><span class="line"><span class="keyword">let</span> 幅度<span class="number">2</span> = <span class="number">2.0</span></span><br><span class="line"><span class="keyword">let</span> 正弦函数<span class="number">2</span> = (<span class="number">0</span>..&lt;函数点阵密度).<span class="built_in">map</span> &#123;</span><br><span class="line">    幅度<span class="number">2</span> * sin(<span class="number">2.0</span> * <span class="type">M_PI</span> / <span class="type">Double</span>(函数点阵密度) * <span class="type">Double</span>($<span class="number">0</span>) * 频率<span class="number">2</span> + 相位<span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> 频率<span class="number">3</span> = <span class="number">10.0</span></span><br><span class="line"><span class="keyword">let</span> 相位<span class="number">3</span> = <span class="type">M_PI</span> / <span class="number">3.0</span></span><br><span class="line"><span class="keyword">let</span> 幅度<span class="number">3</span> = <span class="number">4.0</span></span><br><span class="line"><span class="keyword">let</span> 正弦函数<span class="number">3</span> = (<span class="number">0</span>..&lt;函数点阵密度).<span class="built_in">map</span> &#123;</span><br><span class="line">    幅度<span class="number">3</span> * sin(<span class="number">2.0</span> * <span class="type">M_PI</span> / <span class="type">Double</span>(函数点阵密度) * <span class="type">Double</span>($<span class="number">0</span>) * 频率<span class="number">3</span> + 相位<span class="number">3</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> 新函数<span class="number">1</span> = add(正弦函数<span class="number">1</span>, y: 正弦函数<span class="number">2</span>)</span><br><span class="line"><span class="keyword">let</span> 新函数<span class="number">2</span> = add(新函数<span class="number">1</span>, y: 正弦函数<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Xcode 分栏查看图形排布，尤其是新函数的图形</span></span><br><span class="line">新函数<span class="number">1</span>.forEach &#123; <span class="type">XCPlaygroundPage</span>.currentPage.captureValue($<span class="number">0</span>, withIdentifier:<span class="string">"新函数1"</span>) &#125;</span><br><span class="line">新函数<span class="number">2</span>.forEach &#123; <span class="type">XCPlaygroundPage</span>.currentPage.captureValue($<span class="number">0</span>, withIdentifier:<span class="string">"新函数2"</span>) &#125;</span><br><span class="line"></span><br><span class="line">正弦函数<span class="number">2</span>.forEach &#123; <span class="type">XCPlaygroundPage</span>.currentPage.captureValue($<span class="number">0</span>, withIdentifier:<span class="string">"正弦函数2"</span>) &#125;</span><br><span class="line"></span><br><span class="line">正弦函数<span class="number">1</span>.forEach &#123; <span class="type">XCPlaygroundPage</span>.currentPage.captureValue($<span class="number">0</span>, withIdentifier:<span class="string">"正弦函数1"</span>) &#125;</span><br></pre></td></tr></table></figure>
<h4 id="傅里叶变换通俗篇讲解">傅里叶变换通俗篇<a href="https://www.douban.com/note/164400821" target="_blank" rel="external">讲解</a></h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看图像发现‘新函数2’左右有三对波峰，得出它由三个正弦波组成（可对应得出振幅、频率及相位）</span></span><br><span class="line"><span class="keyword">let</span> 快速傅里叶转换 = fft(新函数<span class="number">2</span>)</span><br><span class="line">快速傅里叶转换.forEach &#123; <span class="type">XCPlaygroundPage</span>.currentPage.captureValue($<span class="number">0</span>, withIdentifier:<span class="string">"快速傅里叶转换"</span>) &#125;</span><br></pre></td></tr></table></figure>
<h3 id="矩阵计算">矩阵计算</h3><blockquote>
<p>很多图像处理是根据矩阵做处理的，像素越大，处理性能要求越高</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 简单矩阵示例</span><br><span class="line"></span><br><span class="line">// ⎛ <span class="number">1</span>  <span class="number">2</span> ⎞      ⎛ <span class="number">3</span>  <span class="number">2</span> ⎞       ⎛ <span class="number">5</span>  <span class="number">6</span> ⎞</span><br><span class="line">// ⎢      ⎟  *   ⎢      ⎟   =   ⎢      ⎟</span><br><span class="line">// ⎝ <span class="number">3</span> -<span class="number">4</span> ⎠      ⎝ <span class="number">1</span>  <span class="number">2</span> ⎠       ⎝ <span class="number">5</span> -<span class="number">2</span> ⎠</span><br><span class="line"></span><br><span class="line">let A = Matrix(<span class="string">[[1, 2], [3, -4]]</span>)</span><br><span class="line">let B = Matrix(<span class="string">[[3, 2], [1, 2]]</span>)</span><br><span class="line">let C = A * B</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 利用逆矩阵求解</span><br><span class="line">// ⎛ <span class="number">1</span>  <span class="number">1</span> ⎞        ⎛ <span class="number">3</span> ⎞           ⎛ <span class="number">2</span> ⎞</span><br><span class="line">// ⎢      ⎟ * CC = ⎢   ⎟    CC =   ⎢   ⎟</span><br><span class="line">// ⎝ <span class="number">1</span> -<span class="number">1</span> ⎠        ⎝ <span class="number">1</span> ⎠           ⎝ <span class="number">1</span> ⎠</span><br><span class="line"></span><br><span class="line">let AA = Matrix(<span class="string">[[1, 1], [1, -1]]</span>)</span><br><span class="line">let BB = Matrix(<span class="string">[[3], [1]]</span>)</span><br><span class="line">let CC = inv(AA) * BB</span><br></pre></td></tr></table></figure>
<h3 id="应用的加速库函数">应用的加速库函数</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="type">Accelerate</span></span><br><span class="line"></span><br><span class="line">public <span class="func"><span class="keyword">func</span> <span class="title">sum</span><span class="params">(x: [Double])</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Double</span> = <span class="number">0.0</span></span><br><span class="line">    vDSP_sveD(x, <span class="number">1</span>, &amp;result, vDSP_Length(x.<span class="built_in">count</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="func"><span class="keyword">func</span> <span class="title">max</span><span class="params">(x: [Double])</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Double</span> = <span class="number">0.0</span></span><br><span class="line">    vDSP_maxvD(x, <span class="number">1</span>, &amp;result, vDSP_Length(x.<span class="built_in">count</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="func"><span class="keyword">func</span> <span class="title">mean</span><span class="params">(x: [Double])</span></span> -&gt; <span class="type">Double</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> result: <span class="type">Double</span> = <span class="number">0.0</span></span><br><span class="line">    vDSP_meanvD(x, <span class="number">1</span>, &amp;result, vDSP_Length(x.<span class="built_in">count</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="func"><span class="keyword">func</span> <span class="title">add</span><span class="params">(x: [Double], y: [Double])</span></span> -&gt; [<span class="type">Double</span>] &#123;</span><br><span class="line">    <span class="keyword">var</span> results = [<span class="type">Double</span>](y)</span><br><span class="line">    cblas_daxpy(<span class="type">Int32</span>(x.<span class="built_in">count</span>), <span class="number">1.0</span>, x, <span class="number">1</span>, &amp;results, <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> results</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="func"><span class="keyword">func</span> <span class="title">fft</span><span class="params">(input: [Double])</span></span> -&gt; [<span class="type">Double</span>] &#123;</span><br><span class="line">    <span class="keyword">var</span> real = [<span class="type">Double</span>](input)</span><br><span class="line">    <span class="keyword">var</span> imaginary = [<span class="type">Double</span>](<span class="built_in">count</span>: input.<span class="built_in">count</span>, repeatedValue: <span class="number">0.0</span>)</span><br><span class="line">    <span class="keyword">var</span> splitComplex = <span class="type">DSPDoubleSplitComplex</span>(realp: &amp;real, imagp: &amp;imaginary)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> length = vDSP_Length(floor(log2(<span class="type">Float</span>(input.<span class="built_in">count</span>))))</span><br><span class="line">    <span class="keyword">let</span> radix = <span class="type">FFTRadix</span>(kFFTRadix2)</span><br><span class="line">    <span class="keyword">let</span> weights = vDSP_create_fftsetupD(length, radix)</span><br><span class="line">    vDSP_fft_zipD(weights, &amp;splitComplex, <span class="number">1</span>, length, <span class="type">FFTDirection</span>(<span class="type">FFT_FORWARD</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> magnitudes = [<span class="type">Double</span>](<span class="built_in">count</span>: input.<span class="built_in">count</span>, repeatedValue: <span class="number">0.0</span>)</span><br><span class="line">    vDSP_zvmagsD(&amp;splitComplex, <span class="number">1</span>, &amp;magnitudes, <span class="number">1</span>, vDSP_Length(input.<span class="built_in">count</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> normalizedMagnitudes = [<span class="type">Double</span>](<span class="built_in">count</span>: input.<span class="built_in">count</span>, repeatedValue: <span class="number">0.0</span>)</span><br><span class="line">    vDSP_vsmulD(sqrt(magnitudes), <span class="number">1</span>, [<span class="number">2.0</span> / <span class="type">Double</span>(input.<span class="built_in">count</span>)], &amp;normalizedMagnitudes, <span class="number">1</span>, vDSP_Length(input.<span class="built_in">count</span>))</span><br><span class="line"></span><br><span class="line">    vDSP_destroy_fftsetupD(weights)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> normalizedMagnitudes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-移动周分享-第59期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/07/15/移动周分享-第59期/" class="article-date">
  	<time datetime="2016-07-15T15:30:00.000Z" itemprop="datePublished">2016-07-15</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/15/移动周分享-第59期/">移动周分享-第59期</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="闲聊前后端分离_-_曾铭">闲聊前后端分离 - 曾铭</h2><ul>
<li>现状与问题</li>
<li>看看历史</li>
<li>看看方案</li>
<li>一些启示</li>
</ul>
<h2 id="如何优雅的自定义Xib_-_刘康">如何优雅的自定义Xib - 刘康</h2><h4 id="先创建一个UIView文件和一个Xib文件，在Xib文件里设置如下：">先创建一个UIView文件和一个Xib文件，在Xib文件里设置如下：</h4><ul>
<li>size: Freeform</li>
<li>Status Bar: None</li>
</ul>
<h4 id="使用-init(frame:_CGRect)而不是-awakeFromNib()：">使用<strong><code>-init(frame: CGRect)</code></strong>而不是<strong><code>-awakeFromNib()</code></strong>：</h4><p>为了能在Storyboard中使用自定义view，需要实现<code>initWithCoder</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="keyword">init</span>(frame: <span class="type">CGRect</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame)</span><br><span class="line">    setupXib()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">required <span class="keyword">init</span>?(coder aDecoder: <span class="type">NSCoder</span>) &#123;</span><br><span class="line">    <span class="keyword">super</span>.<span class="keyword">init</span>(coder: aDecoder)</span><br><span class="line">    setupXib()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="加载Xib关键代码">加载Xib关键代码</h4><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">loadViewFromNib</span><span class="params">()</span></span> -&gt; <span class="type">UIView</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> bundle = <span class="type">NSBundle</span>(forClass: <span class="keyword">self</span>.<span class="keyword">dynamicType</span>)</span><br><span class="line">    <span class="keyword">let</span> nib = <span class="type">UINib</span>(nibName: <span class="string">"WeiboHeader"</span>, bundle: bundle)</span><br><span class="line">    <span class="keyword">let</span> view = nib.instantiateWithOwner(<span class="keyword">self</span>, options: <span class="literal">nil</span>)[<span class="number">0</span>] <span class="keyword">as</span>! <span class="type">UIView</span></span><br><span class="line">    <span class="keyword">return</span> view</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="设置Xib文件的Files_Owner，而不是设置View的Custom_Class">设置<code>Xib</code>文件的<strong><code>Files Owner</code></strong>，而不是设置View的<code>Custom Class</code></h4><p>如果需要UIView和Xib文件建立控件属性关联，是设置Xib文件的File`s Owner，而不是设置View的Custom Class</p>
<p><img src="http://oaclergq7.bkt.clouddn.com/filesowner.jpg" alt="Image show"><br>设置了File`s Owner就可以像往常一样拖线了!</p>
<h4 id="在Storyboard中使用Xib">在Storyboard中使用Xib</h4><p>1.在SB中加入一个UIView，将其Class设置成<code>WeiboHeader</code><br>2.使用<strong><code>@IBInspectable</code></strong></p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">@IBInspectable var <span class="built_in">background</span>: UIImage? &#123;</span><br><span class="line">    <span class="built_in">get</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> backgroundImageView.<span class="built_in">image</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">set</span> &#123;</span><br><span class="line">        backgroundImageView.<span class="built_in">image</span> = newValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@IBInspectable var avatar: UIImage? &#123;</span><br><span class="line">    <span class="built_in">get</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> avatarImageView.<span class="built_in">image</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">set</span> &#123;</span><br><span class="line">        avatarImageView.<span class="built_in">image</span> = newValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@IBInspectable var name: <span class="keyword">String</span>? &#123;</span><br><span class="line">    <span class="built_in">get</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nameLabel.<span class="built_in">text</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">set</span> &#123;</span><br><span class="line">        nameLabel.<span class="built_in">text</span> = newValue</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加了<code>@IBInspectable</code>之后，就可以像系统自带的控件一样设置属性了~</p>
<h2 id="单元测试_-_吴明">单元测试 - 吴明</h2><ul>
<li>注：基于<a href="http://chriszou.com/" target="_blank" rel="external">小创</a>分享的总结</li>
</ul>
<h4 id="明确概念">明确概念</h4><ul>
<li>单元测试 or 集成测试：</li>
<li>单元测试在<a href="https://zh.wikipedia.org/wiki/%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95" target="_blank" rel="external">维基百科</a>是这样定义的</li>
</ul>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">单元测试（英语：<span class="keyword">Unit</span> Testing）又称为模块测试, 是针对程序模块（软件设计的最小单位）来进行正确性检验的测试工作。程序单元是应用的最小可测试部件。在过程化编程中，一个单元就是单个程序、函数、过程等；对于面向对象编程，最小单元就是方法，包括基类（超类）、抽象类、或者派生类（子类）中的方法。</span><br></pre></td></tr></table></figure>
<p>集成测试在<a href="https://zh.wikipedia.org/wiki/%E9%9B%86%E6%88%90%E6%B5%8B%E8%AF%95" target="_blank" rel="external">维基百科</a>的定义<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">集成测试,整合测试又称组装测试，即对程序模块采用一次性或增殖方式组装起来，对系统的接口进行正确性检验的测试工作。整合测试一般在单元测试之后、系统测试之前进行。实践表明，有时模块虽然可以单独工作，但是并不能保证组装起来也可以同时工作</span><br></pre></td></tr></table></figure></p>
<p>有没有理解?那我们在借鉴下《单元测试的艺术》对单元测试和集成测试的定义：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一个单元测试时一段自动化的代码，这段代码调用被测试的工作单元，之后对这个单元的单个最终结果的某些假设进行检验。单元测试几乎都是用单元测试框架编写。单元测试容易编写，能快速运行。单元测试可靠，可读，并且可维护。只要产品代码不发生变化，单元测试的结果是稳定的。</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">集成测试是对一个工作单元进行的测试，这个测试对被测试的工作单元没有完全控制，并使用该单元的一个或者多个真实依赖物，例如时间，网络，数据库，线程或随机数产生器等。</span><br></pre></td></tr></table></figure>
<p>现在应该了解吧，没有了解不要紧，我们再通过他们关系比对<br> 那单元测试和集成测试的关系是怎么样了？<br> <img src="http://7xod3k.com1.z0.glb.clouddn.com/qtijqabixtlihxsuujkwnlzelrqnwqnz" alt="单元测试和集成测试"><br> <a href="http://chriszou.com/2016/04/13/android-unit-testing-start-from-what.html" target="_blank" rel="external">链接</a></p>
<h4 id="优点">优点</h4><ul>
<li>保证代码质量，防止bug或尽早发现bug的作用</li>
<li>改善代码的设计，节约开发调试时间</li>
<li>大大减少重构中手动验证正确性的时间。</li>
<li><p>在写单元测试的时候也能发现方法乃至系统结构设计的不合理</p>
</li>
<li><p>前面都是官方文字，现在讲点实在的。单元测试就是测试方法，方法我们又分为两种</p>
<ul>
<li>有返回值方法</li>
<li>无返回值方法</li>
</ul>
</li>
<li><p>有返回值方法，我们测试这个方法直接通过测试这个方法返回的值是否跟你预期一样。我们就以一个登陆的demo来解析吧</p>
<ul>
<li><p>环境</p>
<ul>
<li>IDE:Android Studio</li>
<li><p>Java测试库:junit，在build.gradle配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>Compile <span class="string">'junit:junit:4.12'</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1534431-784a1cb7911ccafa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="目录结构"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExampleUnitTest</span> </span>&#123;</span><br><span class="line">    <span class="annotation">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addition_isCorrect</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        assertEquals(<span class="number">4</span>, <span class="number">2</span> + <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个是新近一个Android新建的项目，生成的单元测试，直接通过点击方法的运行就能看的结果了。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1534431-6287758ce0be0d42.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="代码"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1534431-82ee776821842f50.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="运行结果"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1534431-d33f48cff28cc3a2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="代码"></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1534431-a0b2da8b0c4418b7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="错误运行结果"><br>实际开发中我们也是通过get()获取指定值比较这个应该比较容易理解。重点就是第二个了</p>
<ul>
<li>无返回值方法，我们只能通过方法内某个对象的方法是否被调用并且调用参数一样。这里就要用到mock，mock其实就是虚拟一个对象，然后根据这个对象方法判断是否被调用，mock目前比较成熟的框架是Mockito，所有我们这里要引用Mockito框架</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dependencies</span> &#123;    </span><br><span class="line"><span class="keyword">compile</span> <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])    </span><br><span class="line">androidTestCompile(<span class="string">'com.android.support.test.espresso:espresso-core:2.2.2'</span>, </span><br><span class="line">&#123;        </span><br><span class="line">  <span class="keyword">exclude</span> <span class="keyword">group</span>: <span class="string">'com.android.support'</span>, module: <span class="string">'support-annotations'</span>    &#125;)</span><br><span class="line">   </span><br><span class="line"> <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:23.4.0'</span>    </span><br><span class="line"><span class="keyword">compile</span> <span class="string">'com.android.support.constraint:constraint-layout:1.0.0-alpha4'</span>    </span><br><span class="line"><span class="comment">//以下测试框架    </span></span><br><span class="line">testCompile <span class="string">"junit:junit:4.12"</span>    </span><br><span class="line"><span class="comment">//mockito    </span></span><br><span class="line">testCompile <span class="string">"org.mockito:mockito-core:1.+"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>先看代码这个是一个简单的login代码<br>Activity</p>
 <figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span>, <span class="title">ILoginView</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> EditText mUserNameView;</span><br><span class="line">    <span class="keyword">private</span> EditText mPassWordView;</span><br><span class="line">    <span class="keyword">private</span> LoginPresenter mPresenter;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        findViewById(R.id.login).setOnClickListener(<span class="keyword">this</span>);</span><br><span class="line">        mUserNameView = (EditText) findViewById(R.id.username);</span><br><span class="line">        mPassWordView = (EditText) findViewById(R.id.password);</span><br><span class="line">        mPresenter = <span class="keyword">new</span> LoginPresenter(<span class="keyword">this</span>, HttpClient.getInstance());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.login:</span><br><span class="line">                String username = mUserNameView.getText().toString();</span><br><span class="line">                String password = mPassWordView.getText().toString();</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.isEmpty(username)) &#123;</span><br><span class="line">                    Toast.makeText(<span class="keyword">this</span>, <span class="string">"用户名不能为空"</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TextUtils.isEmpty(password)) &#123;</span><br><span class="line">                    Toast.makeText(<span class="keyword">this</span>, <span class="string">"密码不能为空"</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                mPresenter.login(username, password);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">startHomeView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"跳转主页"</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"密码错误"</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ILoginView接口</p>
 <figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ILoginView</span> &#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 跳转主页</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">startHomeView</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 错误</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onError</span>(<span class="params"></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HttpClient</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HttpClient mClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> HttpClient <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (HttpClient.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (mClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    mClient = <span class="keyword">new</span> HttpClient();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> mClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callback</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String phone)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(String error)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">(String username, String password, Callback callback)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//为了简单,没有实际操作网络请求只是简单判断返回结果</span></span><br><span class="line">        <span class="keyword">if</span> (username.length() &lt; <span class="number">5</span>) &#123;</span><br><span class="line">            callback.onError(<span class="string">"用户名太短"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            callback.onSuccess(<span class="string">"110110"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>LoginPresenter</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginPresenter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ILoginView mLoginView;</span><br><span class="line">    <span class="keyword">private</span> HttpClient mClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoginPresenter</span><span class="params">(@NonNull ILoginView mLoginView,@NonNull HttpClient client)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mLoginView = mLoginView;</span><br><span class="line">        <span class="keyword">this</span>.mClient = client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">login</span><span class="params">(String username, String password)</span> </span>&#123;</span><br><span class="line">        mClient.login(username, password, <span class="keyword">new</span> HttpClient.Callback() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(String phone)</span> </span>&#123;</span><br><span class="line">                mLoginView.startHomeView();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">onError</span><span class="params">(String <span class="keyword">error</span>)</span> </span>&#123;</span><br><span class="line">                mLoginView.onError();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function">String <span class="title">getDevice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"nexus6p"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>单元测试，mock出来的对象一定要set到这个LoginPresenter对象中，要不然报错org.mockito.exceptions.misusing.NotAMockException</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginPresenterTest</span> </span>&#123;    </span><br><span class="line"><span class="keyword">private</span> LoginPresenter mPresenter;    </span><br><span class="line"><span class="keyword">private</span> ILoginView mLoginView;    </span><br><span class="line"><span class="keyword">private</span> HttpClient mClient;    </span><br><span class="line"><span class="comment">//初始化,每测试一个方法都会掉这个    </span></span><br><span class="line"><span class="annotation">@Before</span>    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;        </span><br><span class="line">mLoginView = Mockito.mock(ILoginView.class);        </span><br><span class="line">mClient = Mockito.mock(HttpClient.class);        </span><br><span class="line">mPresenter = <span class="keyword">new</span> LoginPresenter(mLoginView, mClient);   </span><br><span class="line"> &#125;    </span><br><span class="line"><span class="annotation">@Test</span>    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">login</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;        </span><br><span class="line"><span class="comment">//无返回值方法        </span></span><br><span class="line">mPresenter.login(<span class="string">"123456"</span>, <span class="string">"123456"</span>);   </span><br><span class="line">     Mockito.verify(mClient).login(<span class="string">"123456"</span>, <span class="string">"123456"</span>, <span class="keyword">null</span>);    </span><br><span class="line">&#125;    </span><br><span class="line"><span class="annotation">@Test</span>    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loginTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;        </span><br><span class="line"><span class="comment">//无返回值方法        </span></span><br><span class="line">mPresenter.loginTest(<span class="string">"123456"</span>, <span class="string">"123456"</span>);        </span><br><span class="line">Mockito.verify(mClient).login(<span class="string">"123456"</span>, <span class="string">"123456"</span>, <span class="keyword">null</span>);    </span><br><span class="line">&#125;    </span><br><span class="line"><span class="annotation">@Test</span>    </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getDevice</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;        </span><br><span class="line"><span class="comment">//有返回值方法"        </span></span><br><span class="line">Assert.assertEquals(mPresenter.getDevice(), <span class="string">"nexus6p"</span>);    </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行看结果</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1534431-6e66d663c451a176.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="结果"><br>可以看出login方法有问题，这个错误是正常的，就是我要的结果，可是loginTest方法运行正常，最主要的是他们callback为null，login方法执行的callback不是null，所有login方法执行的时候验证出来就是不一致的。</p>
<ul>
<li>资料<ul>
<li><a href="">Demo地址</a></li>
<li><a href="http://chriszou.com/" target="_blank" rel="external">小创</a></li>
<li><a href="http://tech.meituan.com/" target="_blank" rel="external">美团点评技术团队</a></li>
<li><a href="http://www.ituring.com.cn/book/1336" target="_blank" rel="external">单元测试的艺术</a></li>
</ul>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-移动周分享-第58期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/06/17/移动周分享-第58期/" class="article-date">
  	<time datetime="2016-06-17T10:30:00.000Z" itemprop="datePublished">2016-06-17</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/17/移动周分享-第58期/">移动周分享-第58期</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Java_Annotation_-_王胜">Java Annotation - 王胜</h2><h3 id="Annotation是什么">Annotation是什么</h3><blockquote>
<p>维基百科: A form of syntactic metadaa that can be added to Java source code. 也就是说，Annotation的引入是为了从Java语言层面上，为Java源代码提供元数据的支持。<a href="http://en.wikipedia.org/wiki/Java_annotation" target="_blank" rel="external">参见维基百科</a></p>
</blockquote>
<h3 id="Annotation的用途">Annotation的用途</h3><blockquote>
<p>表象，替代之前JDK1.4开发中，大量繁琐的配置项，Annotation的出现其实可以极大简化配置文件的数量和需要关注配置的内容。但其实，注解带来的益处远不至于此。</p>
</blockquote>
<h3 id="Annotation的分类">Annotation的分类</h3><ul>
<li><p>文档标注型</p>
<p>主要是@Documented,用以标注是否在javadoc中</p>
</li>
<li><p>编译检查型</p>
<p>主要在编译过程中，给Java编译器若干指令，检查Java代码中是否存在若干问题， 改变编译器的动作或者行为，通过Annotation的使用，可以调整和控制编译器的使用以及让编译器提供关于代码的更多的检查和验证。主要有：@Override，@SuppressWarning</p>
</li>
<li><p>代码分析型</p>
<p>此类Annotation是在我们开发中使用最多的，主要是通过Annotation提供给代码更多的额外特性和设置，在Java运行过程中发挥作用。常见的是在Spring或者Hibernate等框架中出现的@Controller，@Service，@Bean， @Table, @Enitty等等.</p>
</li>
</ul>
<h3 id="自定义生命周期为Runtime类型Annotation">自定义生命周期为Runtime类型Annotation</h3><p>Runtime的处理主要依赖于反射的接口，在字节码中寻找Annotation的接口和输入参数，提取其内容和数值。大部分的情况下是基于代理模式，动态生成相应的代理类实例，然后通过代理类，调用相应的InvocationHandler，在InvocationHandler之内完成Annotation所要执行的动作；然后再继续调用原来的方法，继续执行。</p>
<p><strong>用户在定义Runtime类型的Annotation时，需要的步骤：</strong></p>
<ul>
<li>定义Annotation</li>
<li>定义Annotation的处理器类『通过Reflect、InvocationHandler、Proxy.newProxyInstance()来处理具体的逻辑』</li>
<li>选择合适的调用Annotation的时机和切入点。</li>
</ul>
<h3 id="示例">示例</h3><p><img src="http://7xsk2b.com1.z0.glb.clouddn.com/image/custom-annotation-demo.png" alt="custom-annotation-demo.png"></p>
<p>自定义一个@OnClick注解，通过在方法前面加入这个注解，从而为指定的组件动态添加事件监听方法。</p>
<ul>
<li><p>定义OnClick注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="annotation">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="keyword">public</span> <span class="annotation">@interface</span> OnClick &#123;</span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义OnClickProxyFactory来处理动态绑定方法的逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OnClickProxyFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 处理OnClick注解</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> target 包含OnClick注解的目标对象</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleOnClickAnnotation</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class&lt;?&gt; clsTarget = target.getClass();</span><br><span class="line">            <span class="comment">// 检索目标对象的所有方法, 如果含有OnClick注解, 则为注解中声明的属性对象动态添加AddActionListener方法</span></span><br><span class="line">            <span class="keyword">for</span> (Method method : clsTarget.getDeclaredMethods()) &#123;</span><br><span class="line">                OnClick onClickAnnotation = method.getAnnotation(OnClick.class);</span><br><span class="line">                <span class="keyword">if</span> (onClickAnnotation != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Field field = clsTarget.getDeclaredField(onClickAnnotation.value());</span><br><span class="line">                    field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    autoAddActionlistener(field.get(target), getActionListenerProxy(target, method));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 为目标对象添加addActionListener方法, 该方法的参数ActionListener为ActionListener代理对象</span><br><span class="line">     * <span class="doctag">@param</span> target 被添加ActionListener方法的事件源对象</span><br><span class="line">     * <span class="doctag">@param</span> actionListenerProxy ActionListener代理对象</span><br><span class="line">     * <span class="doctag">@throws</span> NoSuchMethodException</span><br><span class="line">     * <span class="doctag">@throws</span> InvocationTargetException</span><br><span class="line">     * <span class="doctag">@throws</span> IllegalAccessException</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">autoAddActionlistener</span><span class="params">(Object target, Object actionListenerProxy)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取JButton的addActionListener方法对象</span></span><br><span class="line">        Method methodAddActionListener = target.getClass().getMethod(<span class="string">"addActionListener"</span>, ActionListener.class);</span><br><span class="line">        <span class="comment">// 为JButton对象添加addActionListener方法</span></span><br><span class="line">        methodAddActionListener.invoke(target, actionListenerProxy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 获取ActionListener的代理对象</span><br><span class="line">     * <span class="doctag">@param</span> target 指定的代理对象</span><br><span class="line">     * <span class="doctag">@param</span> targetMethod 指定的代理对象的方法</span><br><span class="line">     * <span class="doctag">@return</span></span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getActionListenerProxy</span><span class="params">(<span class="keyword">final</span> Object target, <span class="keyword">final</span> Method targetMethod)</span> </span>&#123;</span><br><span class="line">        InvocationHandler handler = <span class="keyword">new</span> InvocationHandler() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> targetMethod.invoke(target);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(target.getClass().getClassLoader(), <span class="keyword">new</span> Class[] &#123;ActionListener.class&#125;, handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在UI初始化时，调用注解的解析和动态处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UI</span> <span class="keyword">extends</span> <span class="title">JFrame</span></span>&#123;</span><br><span class="line">    <span class="comment">// 省略......</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UI</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 省略......</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 通过OnClickProxyFactory工厂来处理OnClick注解</span></span><br><span class="line">      OnClickProxyFactory.handleOnClickAnnotation(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="annotation">@OnClick</span>(<span class="string">"btnBlue"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBlueBackground</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      panel.setBackground(Color.BLUE);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@OnClick</span>(<span class="string">"btnRed"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRedBackground</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      panel.setBackground(Color.RED);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="annotation">@OnClick</span>(<span class="string">"btnSayHello"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      JOptionPane.showConfirmDialog(<span class="keyword">null</span>, <span class="string">"Hello World!"</span>, <span class="string">"Tips"</span>, JOptionPane.YES_OPTION);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>具体的示例源码，移步 <a href="https://github.com/wangsheng/helloJavaSE" target="_blank" rel="external">Github-helloJavaSE</a></p>
<h3 id="参考">参考</h3><ul>
<li><a href="http://blog.csdn.net/blueheart20/article/details/18725801" target="_blank" rel="external">Java Annotation原理分析(一)</a></li>
<li><a href="http://blog.csdn.net/blueheart20/article/details/18761847" target="_blank" rel="external">Java Annotation原理分析(二)</a></li>
<li><a href="http://blog.csdn.net/blueheart20/article/details/18765891" target="_blank" rel="external">Java Annotation原理分析(三)</a></li>
<li><a href="http://blog.csdn.net/blueheart20/article/details/18810693" target="_blank" rel="external">Java Annotation原理分析(四)</a></li>
</ul>
<h2 id="Xcode_MarkDown的代码文档_(_for_swift_)">Xcode MarkDown的代码文档 ( for swift )</h2><p>@(iOS)[Markdown, Document]</p>
<h3 id="markdown在swift中的应用">markdown在swift中的应用</h3><h4 id="goals">goals</h4><ul>
<li>描述各个属性、函数和类的真正用途</li>
<li>高亮函数的输入和输出（参数和返回值）</li>
<li>几个月后还能清晰地记得每个函数属性是为了什么</li>
<li>使用工具制作具有专业外观的使用手册（比如：使用 <a href="https://github.com/realm/jazzy" target="_blank" rel="external">Jazzy</a>）</li>
<li>Xcode 里写的代码文档能被预览</li>
</ul>
<h4 id="markdown_grammar">markdown grammar</h4><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="header">#text#：文本标题</span></span><br><span class="line"></span><br><span class="line"><span class="strong">**text**</span>：使文本具有加粗的效果</span><br><span class="line"></span><br><span class="line"><span class="emphasis">*text*</span>：使文本具有斜体的效果</span><br><span class="line"></span><br><span class="line"><span class="bullet">* </span>text：使文本成为一个无序列表的元素，值得注意的是，有个 * 后面需要有一个空格。同样，可以使用 + 或 - 实现这个的功能</span><br><span class="line"></span><br><span class="line">1.text：使文本成为一个有序列表的元素</span><br><span class="line"></span><br><span class="line">[<span class="link_label">linked text</span>](<span class="link_url">http://some-url.com</span>)：使文本成为可以点击的超链接</span><br><span class="line"></span><br><span class="line">![<span class="link_label">image show</span>](<span class="link_url">http://www.appcoda.com/wp-content/uploads/2016/05/t52_3_help_inspector1.png</span>)：可以显示图片</span><br><span class="line"></span><br><span class="line"><span class="blockquote">&gt; text：创建一个块引用。</span></span><br><span class="line"></span><br><span class="line">使用 4 个空格或 1 个 tab 来缩进所写的代码块，等价于 HTML 中的 \\ 标签。可以继续使用 4 个空格或 1 个 tab 来添加另一个缩进</span><br><span class="line"></span><br><span class="line">如果不想使用空格或 tab 的话，可以使用 <span class="code">` 。比如， `</span>var myProperty` 会显示成 var myProperty</span><br><span class="line"></span><br><span class="line">另一种创建代码块的方法是添加 4 个 <span class="code">`，并从下一行开始写具体的代码，最后添加 4 个 `</span> 表示结束</span><br><span class="line"></span><br><span class="line">反斜杠修饰 Markdown 的特殊字符就可以避免 Markdown 语法的解析了。比如， \<span class="strong">**this\**</span> 就不会产生加粗的效果</span><br></pre></td></tr></table></figure>
<p>注释区域： 3 个斜线（///）或以下面的形式开头：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">*</span>/</span><br></pre></td></tr></table></figure></p>
<h5 id="Case">Case</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">    It calculates and returns the outcome of the division of the two parameters.</span><br><span class="line"></span><br><span class="line">    ## Important Notes ##</span><br><span class="line">    1. Both parameters are **double** numbers.</span><br><span class="line">    2. For a proper result the second parameter *must be other than 0*.</span><br><span class="line">    3. If the second parameter is 0 then the function will return nil.</span><br><span class="line"></span><br><span class="line">*/</span></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">performDivision</span>（<span class="title">number1</span>: <span class="title">Double</span>, <span class="title">number2</span>: <span class="title">Double</span>） -&gt; <span class="title">Double</span>! </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> number2 != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> number1 / number2</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://www.appcoda.com/wp-content/uploads/2016/05/t52_2_quickhelp2.png" alt="case image"></p>
<p><img src="http://www.appcoda.com/wp-content/uploads/2016/05/t52_3_help_inspector1.png" alt="quick look"></p>
<h4 id="关键词">关键词</h4><ul>
<li>Parameter</li>
<li>Returns</li>
<li>Remark</li>
<li>SeeAlso</li>
<li>Precondiction</li>
<li>Requires</li>
<li>Todo</li>
<li>Version</li>
<li>Author</li>
<li>Note</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">    Another complicated function.</span><br><span class="line"></span><br><span class="line">    - Parameter fullname: The fullname that will be broken into its parts.</span><br><span class="line">    - Returns: A *tuple* with the first and last name.</span><br><span class="line"></span><br><span class="line">    - Remark:</span><br><span class="line">        There's a counterpart function that concatenates the first and last name into a full name.</span><br><span class="line"></span><br><span class="line">    - SeeAlso:  `createFullName（_:lastname:）`</span><br><span class="line"></span><br><span class="line">    - Precondition: `fullname` should not be nil.</span><br><span class="line">    - Requires: Both first and last name should be parts of the full name, separated with a *space character*.</span><br><span class="line"></span><br><span class="line">    - Todo: Support middle name in the next version.</span><br><span class="line"></span><br><span class="line">    - Warning: A wonderful **crash** will be the result of a `nil` argument.</span><br><span class="line"></span><br><span class="line">    - Version: 1.1</span><br><span class="line"></span><br><span class="line">    - Author: Myself Only</span><br><span class="line"></span><br><span class="line">    - Note: Too much documentation for such a small function.</span><br><span class="line"> */</span></span><br><span class="line"><span class="func"><span class="keyword">func</span> <span class="title">breakFullName</span>（<span class="title">fullname</span>: <span class="title">String</span>) -&gt; （<span class="title">firstname</span>: <span class="title">String</span>, <span class="title">lastname</span>: <span class="title">String</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> fullnameInPieces = fullname.componentsSeparatedByString（<span class="string">" "</span>）</span><br><span class="line">    <span class="keyword">return</span> （fullnameInPieces[<span class="number">0</span>], fullnameInPieces[<span class="number">1</span>]）</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://www.appcoda.com/wp-content/uploads/2016/05/t52_10_keywords5.png" alt="全关键字"></p>
<h3 id="Jazzy_自动产生代码文档">Jazzy 自动产生代码文档</h3><blockquote>
<p><a href="https://github.com/realm/jazzy" target="_blank" rel="external">Jazzy</a> 是一款可以为 Swift 和 Objective-C 代码产生具有 Apple 风格的代码文档工具。</p>
<h4 id="效果如下">效果如下</h4><p><img src="http://www.appcoda.com/wp-content/uploads/2016/05/t52_15_jazzy_results.png" alt="jazzy 效果"></p>
</blockquote>
<h5 id="下面以Alamofire为例子：">下面以<code>Alamofire</code>为例子：</h5><blockquote>
<p>jazzy —help 查看帮助</p>
<ul>
<li>cd Alamofire 的项目path</li>
<li>jazzy —output /Users/xcodeyang/Desktop/jazzy_document </li>
</ul>
</blockquote>
<p><strong><a href="http://swift.gg/2016/06/15/swift-markdown/" target="_blank" rel="external">参考博客地址</a></strong></p>
<h2 id="Android_App共享文件Uri不能为file://_-_吴明">Android App共享文件Uri不能为file://  - 吴明</h2><ul>
<li>先看异常信息:</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">E/StrictMode: null</span><br><span class="line">              java<span class="class">.lang</span><span class="class">.Throwable</span>: file:<span class="comment">// Uri exposed through Intent.getData()</span></span><br><span class="line">                  at android<span class="class">.os</span><span class="class">.StrictMode</span><span class="class">.onFileUriExposed</span>(StrictMode<span class="class">.java</span>:<span class="number">1757</span>)</span><br><span class="line">                  at android<span class="class">.net</span><span class="class">.Uri</span><span class="class">.checkFileUriExposed</span>(Uri<span class="class">.java</span>:<span class="number">2346</span>)</span><br><span class="line">                  at android<span class="class">.content</span><span class="class">.Intent</span><span class="class">.prepareToLeaveProcess</span>(Intent<span class="class">.java</span>:<span class="number">8045</span>)</span><br><span class="line">                  at android<span class="class">.app</span><span class="class">.Instrumentation</span><span class="class">.execStartActivity</span>(Instrumentation<span class="class">.java</span>:<span class="number">1506</span>)</span><br><span class="line">                  at android<span class="class">.app</span><span class="class">.Activity</span><span class="class">.startActivityForResult</span>(Activity<span class="class">.java</span>:<span class="number">3930</span>)</span><br><span class="line">                  at android<span class="class">.app</span><span class="class">.Activity</span><span class="class">.startActivityForResult</span>(Activity<span class="class">.java</span>:<span class="number">3890</span>)</span><br><span class="line">                  at android<span class="class">.support</span><span class="class">.v4</span><span class="class">.app</span><span class="class">.FragmentActivity</span><span class="class">.startActivityForResult</span>(FragmentActivity<span class="class">.java</span>:<span class="number">843</span>)</span><br><span class="line">                  at android<span class="class">.app</span><span class="class">.Activity</span><span class="class">.startActivity</span>(Activity<span class="class">.java</span>:<span class="number">4213</span>)</span><br><span class="line">                  at android<span class="class">.support</span><span class="class">.v4</span><span class="class">.app</span><span class="class">.ActivityCompatJB</span><span class="class">.startActivity</span>(ActivityCompatJB<span class="class">.java</span>:<span class="number">26</span>)</span><br><span class="line">                  at android<span class="class">.support</span><span class="class">.v4</span><span class="class">.app</span><span class="class">.ActivityCompat</span><span class="class">.startActivity</span>(ActivityCompat<span class="class">.java</span>:<span class="number">133</span>)</span><br><span class="line">                  at com<span class="class">.horizon</span><span class="class">.offer</span><span class="class">.mail</span><span class="class">.maildetail</span><span class="class">.impl</span><span class="class">.ImageAnnexWrapper</span><span class="class">.openFile</span>(ImageAnnexWrapper<span class="class">.java</span>:<span class="number">26</span>)</span><br><span class="line">                  at com<span class="class">.horizon</span><span class="class">.offer</span><span class="class">.mail</span><span class="class">.maildetail</span><span class="class">.MailDetailActivity</span><span class="class">.openAnnexFile</span>(MailDetailActivity<span class="class">.java</span>:<span class="number">184</span>)</span><br><span class="line">                  at com<span class="class">.horizon</span><span class="class">.offer</span><span class="class">.mail</span><span class="class">.maildetail</span><span class="class">.adapter</span><span class="class">.MailAnnexAdapter</span><span class="variable">$MailAnnexViewHolder</span>$<span class="number">1</span>.<span class="function"><span class="title">onClick</span><span class="params">(MailAnnexAdapter.java:<span class="number">75</span>)</span></span></span><br><span class="line">                  at android<span class="class">.view</span><span class="class">.View</span><span class="class">.performClick</span>(View<span class="class">.java</span>:<span class="number">5204</span>)</span><br><span class="line">                  at android<span class="class">.view</span><span class="class">.View</span><span class="variable">$PerformClick</span>.<span class="function"><span class="title">run</span><span class="params">(View.java:<span class="number">21153</span>)</span></span></span><br><span class="line">                  at android<span class="class">.os</span><span class="class">.Handler</span><span class="class">.handleCallback</span>(Handler<span class="class">.java</span>:<span class="number">739</span>)</span><br><span class="line">                  at android<span class="class">.os</span><span class="class">.Handler</span><span class="class">.dispatchMessage</span>(Handler<span class="class">.java</span>:<span class="number">95</span>)</span><br><span class="line">                  at android<span class="class">.os</span><span class="class">.Looper</span><span class="class">.loop</span>(Looper<span class="class">.java</span>:<span class="number">148</span>)</span><br><span class="line">                  at android<span class="class">.app</span><span class="class">.ActivityThread</span><span class="class">.main</span>(ActivityThread<span class="class">.java</span>:<span class="number">5417</span>)</span><br><span class="line">                  at java<span class="class">.lang</span><span class="class">.reflect</span><span class="class">.Method</span><span class="class">.invoke</span>(Native Method)</span><br><span class="line">                  at com<span class="class">.android</span><span class="class">.internal</span><span class="class">.os</span><span class="class">.ZygoteInit</span><span class="variable">$MethodAndArgsCaller</span>.<span class="function"><span class="title">run</span><span class="params">(ZygoteInit.java:<span class="number">726</span>)</span></span></span><br><span class="line">                  at com<span class="class">.android</span><span class="class">.internal</span><span class="class">.os</span><span class="class">.ZygoteInit</span><span class="class">.main</span>(ZygoteInit<span class="class">.java</span>:<span class="number">616</span>)</span><br></pre></td></tr></table></figure>
<p>在StrictMode(严格)模式下，App之间共享资源报的异常。</p>
<ul>
<li>出现这个异常的代码</li>
</ul>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> void openFile(@NonNull Activity activity, @NonNull <span class="keyword">File</span> <span class="keyword">file</span>) &#123;</span><br><span class="line">        <span class="type">Intent</span> <span class="type">intent</span> = new <span class="type">Intent</span>(<span class="type">Intent</span>.ACTION_VIEW);</span><br><span class="line">        <span class="type">intent</span>.addCategory(<span class="type">Intent</span>.CATEGORY_DEFAULT);</span><br><span class="line">        <span class="type">intent</span>.addFlags(<span class="type">Intent</span>.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line">        /**异常这行代码**/</span><br><span class="line">        <span class="type">intent</span>.setDataAndType(Uri.fromFile(<span class="keyword">file</span>), <span class="string">"image/*"</span>);</span><br><span class="line">        ActivityCompat.startActivity(activity, <span class="type">intent</span>, null);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>打印</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Uri.<span class="function"><span class="title">fromFile</span><span class="params">(file)</span></span></span><br></pre></td></tr></table></figure>
<p>输出信息</p>
<figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Uri</span> uri=file:<span class="comment"><span class="markdown">///storage/emulated/0/download/9text.jpg</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>各方说明<ul>
<li><a href="https://developer.android.com/preview/behavior-changes.html#sharing-files" target="_blank" rel="external">Android N中说明Uri不能以file://的原因</a><ul>
<li>传递软件包网域外的 file:// URI 可能给接收器留下无法访问的路径。</li>
<li>访问权限控制 </li>
</ul>
</li>
</ul>
</li>
<li><a href="https://developer.android.com/preview/behavior-changes.html#sharing-files" target="_blank" rel="external">解决办法</a><ul>
<li><a href="https://developer.android.com/reference/android/support/v4/content/FileProvider.html" target="_blank" rel="external">FileProvider</a></li>
</ul>
</li>
<li><p>总结</p>
<ul>
<li><p>开始搜索Uri.fromFile(file)并分析源码</p>
 <figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">  * Creates a Uri from a file. The URI has the form</span><br><span class="line">  * "file://&lt;absolute path&gt;". Encodes path characters with the exception of</span><br><span class="line">  * '/'.</span><br><span class="line">  *</span><br><span class="line">  * &lt;p&gt;Example: "file:///tmp/android.txt"</span><br><span class="line">  *</span><br><span class="line">  * @throws NullPointerException if file is null</span><br><span class="line">  * @return a Uri for the given file</span><br><span class="line">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> Uri fromFile(<span class="keyword">File</span> <span class="keyword">file</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (<span class="keyword">file</span> == <span class="keyword">null</span>) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"file"</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     PathPart path = PathPart.fromDecoded(<span class="keyword">file</span>.getAbsolutePath());</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> HierarchicalUri(</span><br><span class="line">             <span class="string">"file"</span>, Part.EMPTY, path, Part.<span class="keyword">NULL</span>, Part.<span class="keyword">NULL</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p> 没有找到相关解决方案。</p>
</li>
<li><a href="https://developer.android.com/reference/android/os/StrictMode.VmPolicy.Builder.html#detectFileUriExposure(" target="_blank" rel="external">StrictMode的FileUriExposedException异常检测</a>)中有提到FileProvider的使用</li>
<li>我写的一个<a href="https://github.com/milin411/FileIntentDemo.git" target="_blank" rel="external">demo</a></li>
<li>给以后提醒app之间共享数据传Uri不能传file://</li>
</ul>
</li>
<li><p>参考资料</p>
<ul>
<li><a href="https://developer.android.com/reference/android/os/StrictMode.html" target="_blank" rel="external">StrictMode</a> </li>
<li><a href="http://www.jianshu.com/p/5572b42fc63f" target="_blank" rel="external">Android Uri和Java URI的区别</a></li>
<li><a href="http://blog.csdn.net/dlutbrucezhang/article/details/8917303" target="_blank" rel="external">Android的Uri</a> </li>
<li><a href="http://blog.csdn.net/harvic880925/article/details/44679239" target="_blank" rel="external">Uri详解之——Uri结构与代码提取</a></li>
<li><a href="http://blog.csdn.net/zhangyingli/article/details/37902367" target="_blank" rel="external">根据 Android Training课程写的FileProvider小例子</a></li>
<li><a href="https://developer.android.com/preview/behavior-changes.html#sharing-files" target="_blank" rel="external">FileUriExposedException 异常</a></li>
<li><a href="https://developer.android.com/reference/android/support/v4/content/FileProvider.html" target="_blank" rel="external">FileProvider</a></li>
<li><a href="http://blog.csdn.net/zhangyingli/article/details/37902367" target="_blank" rel="external">FileProvider使用</a></li>
</ul>
</li>
</ul>
<h2 id="谓词_-_刘康">谓词 - 刘康</h2><ul>
<li>NSPredicate是Foundation框架中的一个类。</li>
<li>作用：指定数据被获取和过滤的方式。提供了类似于自然语言一样定义一个集合被搜寻的逻辑条件。</li>
</ul>
<p>为了证明NSPredicate的强大功能，先写一个Person类，做准备工作。</p>
<figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">class <span class="keyword">Person</span>: NSObject &#123;</span><br><span class="line">    var name: String</span><br><span class="line">    var age: Int</span><br><span class="line">    init(name: String, age: Int) &#123;</span><br><span class="line">        self.name = name</span><br><span class="line">        self.age = age</span><br><span class="line">        super.init()</span><br><span class="line">    &#125;</span><br><span class="line">    override var description: String &#123;</span><br><span class="line">        return <span class="string">"name: \(self.name), age: \(self.age)"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var colleagues = NSMutableArray()</span><br><span class="line">colleagues.addObject(<span class="keyword">Person</span>(name: <span class="string">"Arthur"</span>, age: 45))</span><br><span class="line">colleagues.addObject(<span class="keyword">Person</span>(name: <span class="string">"Michael"</span>, age: 23))</span><br><span class="line">colleagues.addObject(<span class="keyword">Person</span>(name: <span class="string">"Kenny"</span>, age: 25))</span><br><span class="line">colleagues.addObject(<span class="keyword">Person</span>(name: <span class="string">"Bella"</span>, age: 24))</span><br><span class="line">colleagues.addObject(<span class="keyword">Person</span>(name: <span class="string">"Vincent"</span>, age: 36))</span><br><span class="line">colleagues.addObject(<span class="keyword">Person</span>(name: <span class="string">"Adolph"</span>, age: 39))</span><br></pre></td></tr></table></figure>
<h3 id="基本使用">基本使用</h3><p><strong>找出年龄为24岁的人:</strong></p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> predicateByAge = <span class="type">NSPredicate</span>(format: <span class="string">"age == 24"</span>)</span><br><span class="line"><span class="keyword">let</span> <span class="literal">result</span> = colleagues.filteredArrayUsingPredicate(predicateByAge)</span><br></pre></td></tr></table></figure>
<p><strong>参数可以传入:</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let age = <span class="function"><span class="title">NSNumber</span><span class="params">(int: <span class="number">25</span>)</span></span></span><br><span class="line">let predicateByPassAge = <span class="function"><span class="title">NSPredicate</span><span class="params">(format: <span class="string">"age == %@"</span>, age)</span></span></span><br><span class="line">let result1 = colleagues.<span class="function"><span class="title">filteredArrayUsingPredicate</span><span class="params">(predicateByPassAge)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>也可传入要对比的属性，这里是age. 属性的key:</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let pridicateByAge1 = <span class="function"><span class="title">NSPredicate</span><span class="params">(format: <span class="string">"%K == %@"</span>, <span class="string">"age"</span>, NSNumber(int: <span class="number">36</span>)</span></span>)</span><br><span class="line">let result2 = colleagues.<span class="function"><span class="title">filteredArrayUsingPredicate</span><span class="params">(pridicateByAge1)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>指定通配的变量，这里用24来替代age:</strong></p>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">let</span> pridicateByAge2 = NSPredicate <span class="params">(format: <span class="string">"age == $age"</span>)</span></span><br><span class="line"><span class="built_in">let</span> result3 = colleagues.filteredArrayUsingPredicate<span class="params">(pridicateByAge2.predicateWithSubstitutionVariables<span class="params">([<span class="string">"age"</span>: NSNumber<span class="params">(int: <span class="number">24</span>)</span>])</span>)</span></span><br></pre></td></tr></table></figure>
<h4 id="语法小结">语法小结</h4><ul>
<li>使用<code>%@</code>对应数字，字符串，日期的替代值</li>
<li>使用<code>%K</code>对应要比较的属性，也就是KVC中的key</li>
<li>使用$变量名来表示通配的变量，然后<code>predicateWithSubstitutionVariables</code>来决定具体的变量值</li>
</ul>
<h3 id="基本比较">基本比较</h3><p><strong>找出年龄大于40岁的同事:</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let predicateAgeOver40 = <span class="function"><span class="title">NSPredicate</span><span class="params">(format: <span class="string">"age &gt; 40"</span>)</span></span></span><br><span class="line">let boss = colleagues.<span class="function"><span class="title">filteredArrayUsingPredicate</span><span class="params">(predicateAgeOver40)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>找出年龄在22岁~35岁的人:</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">let minAge = <span class="function"><span class="title">NSNumber</span><span class="params">(int: <span class="number">22</span>)</span></span></span><br><span class="line">let maxAge = <span class="function"><span class="title">NSNumber</span><span class="params">(int: <span class="number">35</span>)</span></span></span><br><span class="line">let predicateByAge3 = <span class="function"><span class="title">NSPredicate</span><span class="params">(format: <span class="string">"age BETWEEN &#123;%@, %@&#125;"</span>, minAge, maxAge)</span></span></span><br><span class="line">let result4 = colleagues.<span class="function"><span class="title">filteredArrayUsingPredicate</span><span class="params">(predicateByAge3)</span></span></span><br></pre></td></tr></table></figure>
<h4 id="语法小结-1">语法小结</h4><ul>
<li><code>&gt;</code> 大于</li>
<li><code>&gt;=</code> 大于等于</li>
<li><code>&lt;</code> 小于</li>
<li><code>&lt;=</code> 小于等于</li>
<li><code>==</code> 等于</li>
<li><code>!=</code> 或者 <code>&lt;&gt;</code> 不等于</li>
<li><code>BETWEEN</code> 介于两者之间,包括上下限</li>
</ul>
<h3 id="复合比较">复合比较</h3><ul>
<li><code>&amp;&amp;</code> 或者<code>AND</code> 逻辑与</li>
<li><code>||</code> 或者 <code>OR</code> 逻辑或</li>
<li><code>!</code>或者<code>NOT</code> 逻辑非</li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let predicateByCompare = <span class="function"><span class="title">NSPredicate</span><span class="params">(format: <span class="string">"age &lt; 30 OR age &gt;= 40"</span>)</span></span></span><br><span class="line">let result5 = colleagues.<span class="function"><span class="title">filteredArrayUsingPredicate</span><span class="params">(predicateByCompare)</span></span></span><br></pre></td></tr></table></figure>
<h3 id="字符串比较">字符串比较</h3><ul>
<li><code>BEGINSWITH</code> 左边表达式以右边表达式开头</li>
<li><code>CONTAINS</code> 左边表达式包含右边表达式</li>
<li><code>ENDSWITH</code> 左边表达式以右边表达式结尾</li>
<li><code>LIKE</code> 左边表达式和右边表达式相似（简单的正则表达式匹配，?匹配一个字符，*匹配0个或者多个字符）</li>
<li><code>MATCHES</code> 可以实现较为复杂的正则表达式匹配</li>
<li>用方括号加<code>cd</code>来不区分大小写和变音符号</li>
<li><code>IN</code> 左边的表达式在右边的集合里</li>
</ul>
<p><strong>找出名字以“A”开头的同事:</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let pridivateByName1 = <span class="function"><span class="title">NSPredicate</span><span class="params">(format: <span class="string">"name BEGINSWITH %@"</span>, <span class="string">"A"</span>)</span></span></span><br><span class="line">let result6 = colleagues.<span class="function"><span class="title">filteredArrayUsingPredicate</span><span class="params">(pridivateByName1)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>名字里包含in,不区分大小写，并且年龄大于等于24:</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let pridivateByName2 = <span class="function"><span class="title">NSPredicate</span><span class="params">(format: <span class="string">"name CONTAINS %@ &amp;&amp; age &gt;= %@"</span>, <span class="string">"in"</span>, NSNumber(int: <span class="number">24</span>)</span></span>)</span><br><span class="line">let result7 = colleagues.<span class="function"><span class="title">filteredArrayUsingPredicate</span><span class="params">(pridivateByName2)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>复合正则表达式<code>T[a-z]*k</code>:</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let privatedivateByName3 = <span class="function"><span class="title">NSPredicate</span><span class="params">(format: <span class="string">"name MATCHES 'T[a-z]*k'"</span>)</span></span></span><br><span class="line">let result8 = colleagues.<span class="function"><span class="title">filteredArrayUsingPredicate</span><span class="params">(privatedivateByName3)</span></span></span><br></pre></td></tr></table></figure>
<p><strong>名字是两者中的一个:</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let privatedivateByName4 = <span class="function"><span class="title">NSPredicate</span><span class="params">(format: <span class="string">"name IN &#123;'Bella', 'Jack Tomphon'&#125;"</span>)</span></span></span><br><span class="line">let result9 = colleagues.<span class="function"><span class="title">filteredArrayUsingPredicate</span><span class="params">(privatedivateByName4)</span></span></span><br></pre></td></tr></table></figure>
<h3 id="基于Block的谓词">基于Block的谓词</h3><p><strong>基于Block能够灵活的定制谓词，这里简单的Block定义<code>age &gt; 24</code>:</strong></p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> blockPredicate = <span class="type">NSPredicate</span> &#123; (person: <span class="type">AnyObject</span>!, _) -&gt; <span class="type">Bool</span> <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">var</span> <span class="literal">result</span> = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> castResult = person <span class="keyword">as</span>? <span class="type">Person</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> castResult.age &gt; <span class="number">24</span> &#123;</span><br><span class="line">            <span class="literal">result</span> = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">result</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> result10 = colleagues.filteredArrayUsingPredicate(blockPredicate)</span><br></pre></td></tr></table></figure>
<h3 id="Array使用谓词参考：">Array使用谓词参考：</h3><p><a href="http://stackoverflow.com/questions/24382580/filteredarrayusingpredicate-does-not-exist-in-swift-array" target="_blank" rel="external">StackOverFlow</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-移动周分享-第57期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/27/移动周分享-第57期/" class="article-date">
  	<time datetime="2016-05-27T10:30:00.000Z" itemprop="datePublished">2016-05-27</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/27/移动周分享-第57期/">移动周分享-第57期</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Java_Runtime_动态代理_-_王胜">Java Runtime 动态代理 - 王胜</h2><p>使用过Spring的朋友应该对AOP『Aspected Oriented Programe』很熟悉，那么是否被里面的前置增强、后置增强、环绕增强所震撼呢？有没有想过这背后的技术实现呢？其实JDK的动态代理就能实现。下面做一个简单的示例，来阐述如何在Runtime时，动态增强原有的方法。</p>
<h3 id="前提环境">前提环境</h3><p>假设我们有一个<code>Waiter</code>类，里面含有两个方法:</p>
<ul>
<li>welcome() // 欢迎光临!</li>
<li>bye() // 谢谢惠顾!</li>
</ul>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">欢迎光临!</span><br><span class="line">谢谢惠顾!</span><br><span class="line"></span><br><span class="line"><span class="keyword">Process</span> finished <span class="keyword">with</span> <span class="keyword">exit</span> code <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>后来发现欢迎顾客和送别顾客不够礼貌，需要在欢迎之前说『您好！』，送别顾客后说『祝您愉快!』。但我们不希望动原有的业务类<code>Waiter</code>，那么如何实现呢？</p>
<h3 id="实现步骤">实现步骤</h3><ol>
<li><p>创建一个业务对象『必须要有接口』, 执行业务方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Receptor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">welcome</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">bye</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Waiter</span> <span class="keyword">implements</span> <span class="title">Receptor</span></span>&#123;</span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">welcome</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          System.out.println(<span class="string">"欢迎光临!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="annotation">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bye</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          System.out.println(<span class="string">"谢谢惠顾!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个具有公用代码的对象，并将这些公用代码声明成方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PoliteWords</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"您好!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHappy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"祝您愉快!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个可以使用公用代码对象的对象，这个对象可以对要被处理的目标对象实施方法拦截，执行公用代码对象中的方法。借助JDK提供的API『InvocationHandler』</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceptorHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 省略...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 重写invoke方法,从而达到增强目标对象的目的</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> proxy 增强后的对象</span><br><span class="line">     * <span class="doctag">@param</span> method 目标对象上正在被调用的方法</span><br><span class="line">     * <span class="doctag">@param</span> args 目标对象上正在被调用的方法所传递的参数</span><br><span class="line">     * <span class="doctag">@return</span> 目标对象正在被调用的方法执行的结果</span><br><span class="line">     * <span class="doctag">@throws</span> Throwable</span><br><span class="line">     */</span></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        Object result;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">"welcome"</span>)) &#123;<span class="comment">// welcome之前sayHello</span></span><br><span class="line">            interceptor.sayHello();</span><br><span class="line">            result = method.invoke(target, args);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.getName().equals(<span class="string">"bye"</span>)) &#123;<span class="comment">// bye之后sayHappy</span></span><br><span class="line">            result = method.invoke(target, args);</span><br><span class="line">            interceptor.sayHappy();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result = method.invoke(target, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个可以获取增强了功能之后对象的代理工厂，工厂的作用就是返回增强后的代理Proxy, 他的类型应该和目标对象的接口类型相同。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReceptorProxyFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getProxy</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        ReceptorHandler handler = <span class="keyword">new</span> ReceptorHandler();</span><br><span class="line">        handler.setTarget(target);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(), handler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写测试类（可选）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProxy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Waiter target = <span class="keyword">new</span> Waiter();</span><br><span class="line">        Receptor receptor = (Receptor) ReceptorProxyFactory.getProxy(target);</span><br><span class="line">        receptor.welcome();</span><br><span class="line">        receptor.bye();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>具体的示例源码，移步 <a href="https://github.com/wangsheng/helloJavaSE" target="_blank" rel="external">Github-helloJavaSE</a></p>
<h3 id="执行结果">执行结果</h3><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">您好<span class="exclamation_mark">!</span></span><br><span class="line">欢迎光临<span class="exclamation_mark">!</span></span><br><span class="line">谢谢惠顾<span class="exclamation_mark">!</span></span><br><span class="line">祝您愉快<span class="exclamation_mark">!</span></span><br><span class="line"></span><br><span class="line"><span class="variable">Process</span> <span class="function_or_atom">finished</span> <span class="function_or_atom">with</span> <span class="function_or_atom">exit</span> <span class="function_or_atom">code</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p><strong>注意:</strong> JDK动态代理只能代理接口类型的对象，并且返回接口类型。如果要增强那些没有接口的对象，JDK动态代理不能实现，要依赖 <a href="https://github.com/cglib/cglib" target="_blank" rel="external">CGLIB</a> 技术。</p>
<h2 id="Android转场动画">Android转场动画</h2><ul>
<li><p>startActivity()</p>
  <figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	Intent intent = new Intent<span class="list">(<span class="keyword">MainActivity</span>.this,OtherActivity.class)</span><span class="comment">;</span></span><br><span class="line">startActivity<span class="list">(<span class="keyword">intent</span>)</span><span class="comment">;</span></span><br><span class="line">overridePendingTransition<span class="list">(<span class="keyword">R</span>.anim.push_up_in,R.anim.push_up_out)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ActivityCompat</p>
</li>
</ul>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ActivityCompat.startActivity<span class="params">(<span class="params">(Activity)</span> context, intent, null)</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> static void startActivity(Activity activity, <span class="type">Intent</span> <span class="type">intent</span>, @Nullable Bundle options) &#123;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">16</span>) &#123;</span><br><span class="line">        ActivityCompatJB.startActivity(activity, <span class="type">intent</span>, options);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        activity.startActivity(<span class="type">intent</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Android 4.1（API16)以下转场动画</li>
</ul>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AIntent intent = new Intent<span class="list">(<span class="keyword">MainActivity</span>.this,OtherActivity.class)</span><span class="comment">;</span></span><br><span class="line">startActivity<span class="list">(<span class="keyword">intent</span>)</span><span class="comment">;</span></span><br><span class="line">overridePendingTransition<span class="list">(<span class="keyword">R</span>.anim.push_up_in,R.anim.push_up_out)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>Android 4.1（API16）以上转场动画</p>
<ul>
<li><a href="https://developer.android.com/reference/android/app/ActivityOptions.html" target="_blank" rel="external">ActivityOptions</a><ul>
<li>Android 4.1（API16）提供了一个新类ActivityOptions,用来实现Activity的切换动画。</li>
</ul>
</li>
<li><p>ActivityOptions常用使用 </p>
<ul>
<li><p>makeClipRevealAnimation(View source, int startX, int startY, int width, int height)</p>
<figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Added <span class="keyword">in</span> API level <span class="number">23</span></span><br><span class="line"><span class="string">``</span><span class="string">``</span> </span><br><span class="line">- makeCustomAnimation(Context context, <span class="keyword">int</span> enterResId, <span class="keyword">int</span> exitResId)</span><br></pre></td></tr></table></figure>
<p>Added in API level 16</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- makeScaleUpAnimation(View source, <span class="built_in">int</span> startX, <span class="built_in">int</span> startY, <span class="built_in">int</span> <span class="variable">width</span>, <span class="built_in">int</span> <span class="variable">height</span>)</span><br></pre></td></tr></table></figure>
<p>Added in API level 16</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="subst">-</span> makeSceneTransitionAnimation(Activity activity, <span class="built_in">Pair</span><span class="attribute">...</span><span class="subst">&lt;</span>View, <span class="built_in">String</span><span class="subst">&gt;</span> sharedElements)</span><br></pre></td></tr></table></figure>
<p>Added in API level 21</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- <span class="function"><span class="title">makeSceneTransitionAnimation</span><span class="params">(Activity activity, View sharedElement, String sharedElementName)</span></span></span><br></pre></td></tr></table></figure>
<p>Added in API level 21</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- <span class="function"><span class="title">makeTaskLaunchBehind</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure>
<p>Added in API level 21</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- makeThumbnailScaleUpAnimation(View <span class="keyword">source</span>, Bitmap thumbnail, <span class="keyword">int</span> startX, <span class="keyword">int</span> startY)</span><br></pre></td></tr></table></figure>
<p>Added in API level 16</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">-<span class="ruby"> <span class="constant">ActivityOptions</span>兼容包：<span class="constant">ActivityOptionsCompat</span></span><br><span class="line"></span>	-<span class="ruby"> 自定义动画<span class="symbol">:makeCustomAnimation</span></span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>public static ActivityOptions makeCustomAnimation(Context context,</p>
<pre><code><span class="keyword">int</span> enterResId, <span class="keyword">int</span> exitResId) {
</code></pre><p>return makeCustomAnimation(context, enterResId, exitResId, null, null);</p>
<pre><code>}
</code></pre><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">		</span><br><span class="line">enterResId:开启的动画</span><br><span class="line">exitResId：退出的动画</span><br><span class="line">		</span><br><span class="line">-<span class="ruby"> makeThumbnailAspectScaleDownAnimation</span><br><span class="line"></span>-<span class="ruby"> makeClipRevealAnimation</span><br><span class="line"></span>		-<span class="ruby"> <span class="constant">Android</span> <span class="constant">API19</span>以上使用</span><br><span class="line"></span>-<span class="ruby"> makeScaleUpAnimation</span><br><span class="line"></span>		-<span class="ruby"> 放大动画，从指定view的指定位置开始放大 </span><br><span class="line"></span>-<span class="ruby"> makeSceneTransitionAnimation</span><br><span class="line"></span>		-<span class="ruby"> 共享view放大效果，仅支持<span class="constant">API</span>&gt;=<span class="number">21</span> </span><br><span class="line"></span>-<span class="ruby"> 底层实现动画：什么动画实现？</span></span><br></pre></td></tr></table></figure>
<p>ActivityTransitionState</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>
<p>public void startExitOutTransition(Activity activity, Bundle options) {<br>  if (!activity.getWindow().hasFeature(Window.FEATURE_ACTIVITY_TRANSITIONS)) {</p>
<pre><code><span class="keyword">return</span>;
</code></pre><p>  }<br>  ActivityOptions activityOptions = new ActivityOptions(options);<br>  mEnterTransitionCoordinator = null;<br>  //是否转场动画<br>  if (activityOptions.getAnimationType() == ActivityOptions.ANIM_SCENE_TRANSITION) {</p>
<pre><code>int key = activityOptions.getExitCoordinatorKey<span class="params">()</span>;
int index = mExitTransitionCoordinators.indexOfKey<span class="params">(key)</span>;
<span class="keyword">if</span> <span class="params">(index &gt;= <span class="number">0</span>)</span> {
    mCalledExitCoordinator = mExitTransitionCoordinators.valueAt<span class="params">(index)</span>.get<span class="params">()</span>;
    mExitTransitionCoordinators.removeAt<span class="params">(index)</span>;
    <span class="keyword">if</span> <span class="params">(mCalledExitCoordinator != null)</span> {
        mExitingFrom = mCalledExitCoordinator.getAcceptedNames<span class="params">()</span>;
        mExitingTo = mCalledExitCoordinator.getMappedNames<span class="params">()</span>;
        mExitingToView = mCalledExitCoordinator.copyMappedViews<span class="params">()</span>;
        mCalledExitCoordinator.startExit<span class="params">()</span>;
    }
}
</code></pre><p>  }<br>}</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">	-<span class="ruby"> <span class="constant">Transition</span>解析</span><br><span class="line"></span>		-<span class="ruby"> [<span class="constant">Android</span>最新动画框架完全解析（二）——<span class="constant">Transitions</span> <span class="constant">Framework</span>](<span class="symbol">http:</span>/<span class="regexp">/blog.csdn.net/l</span>664675249/article/details/<span class="number">50195847</span><span class="comment">#t0)</span></span><br><span class="line"></span>		-<span class="ruby"> [<span class="constant">Android</span>最新动画框架完全解析（一）—— <span class="constant">Animator</span>(<span class="constant">Property</span> <span class="constant">Animation</span>)](<span class="symbol">http:</span>/<span class="regexp">/blog.csdn.net/l</span>664675249/article/details/<span class="number">50204503</span>)</span><br><span class="line"></span>-<span class="ruby"> <span class="constant">FragmentTransaction</span>动画</span><br><span class="line"></span>	-<span class="ruby"> setCustomAnimations(int enter, int exit, int popEnter, int popExit)</span></span><br></pre></td></tr></table></figure>
<p>Added in API level 13</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- setCustomAnimations(<span class="keyword">int</span> enter, <span class="keyword">int</span> <span class="built_in">exit</span>)</span><br></pre></td></tr></table></figure>
<p>Added in API level 11</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- <span class="function"><span class="title">setTransition</span><span class="params">(int transit)</span></span></span><br></pre></td></tr></table></figure>
<p>Added in API level 1<br>TRANSIT_NONE, TRANSIT_FRAGMENT_OPEN, or TRANSIT_FRAGMENT_CLOSE</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">- </span>底层源码:什么动画实现？</span><br></pre></td></tr></table></figure>
<p>BackStackState</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">	</span><br></pre></td></tr></table></figure>
<p>public void run() {<br>  if (FragmentManagerImpl.DEBUG) Log.v(TAG, “Run: “ + this);</p>
<p>  if (mAddToBackStack) {</p>
<pre><code><span class="keyword">if</span> (mIndex &lt; <span class="number">0</span>) {
    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"addToBackStack() called after commit()"</span>);
}
</code></pre><p>  }</p>
<p>  bumpBackStackNesting(1);</p>
<p>  TransitionState state = null;<br>  SparseArray<fragment> firstOutFragments = null;<br>  SparseArray<fragment> lastInFragments = null;<br>  if (SUPPORTS_TRANSITIONS &amp;&amp; mManager.mCurState &gt;= Fragment.CREATED) {</fragment></fragment></p>
<pre><code>firstOutFragments = new SparseArray<span class="variable">&lt;Fragment&gt;</span>();
lastInFragments = new SparseArray<span class="variable">&lt;Fragment&gt;</span>();

calculateFragments(firstOutFragments, lastInFragments);

<span class="keyword">state</span> = beginTransition(firstOutFragments, lastInFragments, false);
</code></pre><p>  }</p>
<p>  int transitionStyle = state != null ? 0 : mTransitionStyle;<br>  int transition = state != null ? 0 : mTransition;<br>  Op op = mHead;<br>  while (op != null) {</p>
<pre><code><span class="typename">int</span> enterAnim = state != <span class="literal">null</span> ? 0 : op.enterAnim;
<span class="typename">int</span> exitAnim = state != <span class="literal">null</span> ? 0 : op.exitAnim;
<span class="keyword">switch</span> (op.cmd) {
    <span class="keyword">case</span> <span class="string">OP_ADD:</span> {
        Fragment f = op.fragment;
        f.mNextAnim = enterAnim;
        mManager.addFragment(f, <span class="literal">false</span>);
    } <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string">OP_REPLACE:</span> {
        Fragment f = op.fragment;
        <span class="typename">int</span> containerId = f.mContainerId;
        <span class="keyword">if</span> (mManager.mAdded != <span class="literal">null</span>) {
            <span class="keyword">for</span> (<span class="typename">int</span> i = mManager.mAdded.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {
                Fragment old = mManager.mAdded.get(i);
                <span class="keyword">if</span> (FragmentManagerImpl.DEBUG) Log.v(TAG,
                        <span class="string">"OP_REPLACE: adding="</span> + f + <span class="string">" old="</span> + old);
                <span class="keyword">if</span> (old.mContainerId == containerId) {
                    <span class="keyword">if</span> (old == f) {
                        op.fragment = f = <span class="literal">null</span>;
                    } <span class="keyword">else</span> {
                        <span class="keyword">if</span> (op.removed == <span class="literal">null</span>) {
                            op.removed = <span class="keyword">new</span> ArrayList&lt;Fragment&gt;();
                        }
                        op.removed.add(old);
                        old.mNextAnim = exitAnim;
                        <span class="keyword">if</span> (mAddToBackStack) {
                            old.mBackStackNesting += <span class="number">1</span>;
                            <span class="keyword">if</span> (FragmentManagerImpl.DEBUG) Log.v(TAG, <span class="string">"Bump nesting of "</span>
                                    + old + <span class="string">" to "</span> + old.mBackStackNesting);
                        }
                        mManager.removeFragment(old, transition, transitionStyle);
                    }
                }
            }
        }
        <span class="keyword">if</span> (f != <span class="literal">null</span>) {
            f.mNextAnim = enterAnim;
            mManager.addFragment(f, <span class="literal">false</span>);
        }
    } <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string">OP_REMOVE:</span> {
        Fragment f = op.fragment;
        f.mNextAnim = exitAnim;
        mManager.removeFragment(f, transition, transitionStyle);
    } <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string">OP_HIDE:</span> {
        Fragment f = op.fragment;
        f.mNextAnim = exitAnim;
        mManager.hideFragment(f, transition, transitionStyle);
    } <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string">OP_SHOW:</span> {
        Fragment f = op.fragment;
        f.mNextAnim = enterAnim;
        mManager.showFragment(f, transition, transitionStyle);
    } <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string">OP_DETACH:</span> {
        Fragment f = op.fragment;
        f.mNextAnim = exitAnim;
        mManager.detachFragment(f, transition, transitionStyle);
    } <span class="keyword">break</span>;
    <span class="keyword">case</span> <span class="string">OP_ATTACH:</span> {
        Fragment f = op.fragment;
        f.mNextAnim = enterAnim;
        mManager.attachFragment(f, transition, transitionStyle);
    } <span class="keyword">break</span>;
<span class="label">    default:</span> {
        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unknown cmd: "</span> + op.cmd);
    }
}
op = op.next;
</code></pre><p>  }</p>
<p>  mManager.moveToState(mManager.mCurState, transition, transitionStyle, true);</p>
<p>  if (mAddToBackStack) {</p>
<pre><code>mManager.addBackStackState(<span class="keyword">this</span>);
</code></pre><p>  }<br>}<br>````</p>
</li>
<li><a href="http://www.jianshu.com/p/fd71d65f0ec6" target="_blank" rel="external">为什么不建议用FragmentTransaction动画</a></li>
<li><a href="http://blog.csdn.net/guolin_blog/article/details/43536355" target="_blank" rel="external">Android动画</a></li>
</ul>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-移动周分享-第56期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/20/移动周分享-第56期/" class="article-date">
  	<time datetime="2016-05-20T14:35:00.000Z" itemprop="datePublished">2016-05-20</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/20/移动周分享-第56期/">移动周分享-第56期</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="RunTime简介及实践_-_刘康">RunTime简介及实践 - 刘康</h2><h4 id="前言">前言</h4><p>今年年初的面试中，基本上超过了60%的公司会问RunTime的一些用法。<br>在很多开源项目中用到了RunTime的方法，使我们理解起来比较吃力。<br>RunTime确实很强大，借助它可以实现很酷的功能。比如<code>JSPatch</code>。<br>我本身对于RunTime的理解也没有很深入，所以这里讨论的主要是RunTime的具体应用场景。此番探索希望能起到抛砖引玉的作用，大家可以将RunTime应用起来。</p>
<h4 id="简介">简介</h4><ul>
<li>RunTime简称运行时。是一套底层的<code>C语言API</code>，包含很多强大实用的C语言数据类型和C语言函数，平时我们编写的ObjC代码，底层都是基于runtime实现的。ObjC就是运行时机制，也就是在运行时候的一些机制，其中最主要的是消息机制。比如：</li>
</ul>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>发送消息<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line">Person<span class="keyword">*</span> p = [[Person alloc] init];</span><br><span class="line"></span><br><span class="line">// 调用对象方法</span><br><span class="line">[p eat];</span><br><span class="line">// 本质是向对象发送消息： objc_msgSend(p, <span class="comment">@selector(eat));</span></span><br><span class="line"></span><br><span class="line">// 调用类方法的方式有两种</span><br><span class="line">// 第一种通过类名调用</span><br><span class="line">[Person eat];</span><br><span class="line">// 第二种通过类对象调用</span><br><span class="line">[[Person class] eat];</span><br><span class="line">// 用类名调用类方法，底层会自动把类名转换成类对象调用</span><br><span class="line">// 本质：让类对象发送消息：objc_msgSend([Person class], <span class="comment">@selector(eat));</span></span><br></pre></td></tr></table></figure>
<ul>
<li>对于C语言，函数的调用在编译的时候会决定调用哪个函数。</li>
<li>对于OC的函数，属于动态调用过程，在编译的时候并不能决定真正调用哪个函数，只有在真正运行的时候才会根据函数的名称找到对应的函数来调用。</li>
<li>事实证明：<ul>
<li>在编译阶段，OC可以<strong>调用任何函数</strong>，即使这个函数并未实现，只要声明过就不会报错。</li>
<li>在编译阶段，C语言调用<strong>未实现的函数</strong>就会报错。</li>
</ul>
</li>
</ul>
<h4 id="实践">实践</h4><h5 id="一-_方法交换">一. 方法交换</h5><ul>
<li>开发使用场景:系统自带的方法功能不够，给系统自带的方法扩展一些功能，并且保持原有的功能。<ul>
<li>方式一:继承系统的类，重写方法.</li>
<li>方式二:使用runtime，交换方法.</li>
</ul>
</li>
</ul>
<p>例如，有需求如下：<br><strong>给imageNamed方法提供功能，每次加载图片就判断图片是否加载成功。</strong></p>
<p>runtime实现思路：</p>
<ol>
<li>写一个UIImage分类，在分类中定义一个能加载图片并且能打印的方法+ (instancetype)imageWithName:(NSString *)name;</li>
<li>交换imageNamed和imageWithName的实现，就能调用imageWithName，间接调用imageWithName的实现。</li>
</ol>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">UIImage</span> (<span class="title">image</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 交换方法</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取imageWithName方法地址</span></span><br><span class="line">    Method imageWithName = class_getClassMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(imageWithName:));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取imageWithName方法地址</span></span><br><span class="line">    Method imageName = class_getClassMethod(<span class="keyword">self</span>, <span class="keyword">@selector</span>(imageNamed:));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 交换方法地址，相当于交换实现方式</span></span><br><span class="line">    method_exchangeImplementations(imageWithName, imageName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 既能加载图片又能打印</span></span><br><span class="line">+ (instancetype)imageWithName:(<span class="built_in">NSString</span> *)name</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 这里调用imageWithName，相当于调用imageName</span></span><br><span class="line">    <span class="built_in">UIImage</span> *image = [<span class="keyword">self</span> imageWithName:name];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (image == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"加载空的图片"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> image;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h5 id="二-_动态添加方法">二. 动态添加方法</h5><ul>
<li>开发使用场景：如果一个类，方法非常多，加载类到内存的时候也比较耗费资源，因为需要给每个方法生成映射表。可以使用动态给某个类添加方法解决。</li>
<li>面试题：有没有使用<code>performSelector</code>，其实主要想问你有没有动态添加过方法。</li>
</ul>
<p>例如，给person类增加walk的功能， 默认person，没有实现walk方法，通过performSelector调用会报错。但当我动态添加了方法调用<code>[p performSelector:@selector(walk)]</code>就不会报错了：</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认方法都有两个隐式参数</span></span><br><span class="line"><span class="keyword">void</span> walk(<span class="keyword">id</span> <span class="keyword">self</span>, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@ %@"</span>,<span class="keyword">self</span>,<span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当一个对象调用未实现的方法，会调用这个方法处理,并且会把对应的方法列表传过来.</span></span><br><span class="line"><span class="comment">// 这儿可以用来判断，未实现的方法是不是我们想要动态添加的方法</span></span><br><span class="line">+ (<span class="built_in">BOOL</span>)resolveInstanceMethod:(SEL)sel</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (sel == <span class="keyword">@selector</span>(walk)) &#123;</span><br><span class="line">        <span class="comment">// 动态添加walk方法</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 第一个参数：给哪个类添加方法</span></span><br><span class="line">        <span class="comment">// 第二个参数：添加方法的方法编号</span></span><br><span class="line">        <span class="comment">// 第三个参数：添加方法的函数实现（函数地址）</span></span><br><span class="line">        <span class="comment">// 第四个参数：函数的类型，(返回值+参数类型) v:void @:对象-&gt;self :表示SEL-&gt;_cmd</span></span><br><span class="line">        class_addMethod(<span class="keyword">self</span>, sel, walk, <span class="string">"v@:"</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> [<span class="keyword">super</span> resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="三-_给分类添加属性">三. 给分类添加属性</h5><ul>
<li>原理：给一个类声明属性，其实本质就是给这个类添加关联，并不是直接把这个值的内存空间添加到类存空间。</li>
</ul>
<p>例如：给<code>NSObject</code>添加一个<code>name</code>属性。<br>思路：在NSObject中，setName方法中设置关联值，name方法中通过取出关联值。达到添加属性的效果。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义关联的key</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *key = <span class="string">"name"</span>;</span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Property</span>)</span></span><br><span class="line">- (<span class="built_in">NSString</span> *)name</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 根据关联的key，获取关联的值。</span></span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, key);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)name</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 第一个参数：给哪个对象添加关联</span></span><br><span class="line">    <span class="comment">// 第二个参数：关联的key，通过这个key获取</span></span><br><span class="line">    <span class="comment">// 第三个参数：关联的value</span></span><br><span class="line">    <span class="comment">// 第四个参数：关联的策略</span></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, key, name, OBJC_ASSO<span class="built_in">CIATION_RETAIN_NONATOMIC</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h5 id="四-_更便捷的archive/unarchive">四. 更便捷的archive/unarchive</h5><p>需求：实现对象的归档和解档<br>思路：利用Runtime实现快速遍历对象的所有属性，减少大量类似于<code>self.property=[aDecoder decodeObjectForKey:type];</code>以及<code>[aCoder encodeObject:self.property forKey:type]</code>这种代码。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)encodeWithCoder:(<span class="built_in">NSCoder</span> *)encoder&#123;</span><br><span class="line">    <span class="comment">//归档存储自定义对象</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//获得指向该类所有属性的指针</span></span><br><span class="line">    objc_property_t *properties = class_copyPropertyList([Person class], &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">        <span class="comment">//获得</span></span><br><span class="line">        objc_property_t property = properties[i];</span><br><span class="line">        <span class="comment">//根据objc_property_t获得其属性的名称---&gt;C语言的字符串</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *name = property_getName(property);</span><br><span class="line">        <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">        <span class="comment">// 编码每个属性,利用kVC取出每个属性对应的数值</span></span><br><span class="line">        [encoder encodeObject:[<span class="keyword">self</span> valueForKeyPath:key] forKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithCoder:(<span class="built_in">NSCoder</span> *)decoder&#123;</span><br><span class="line">    <span class="comment">//归档存储自定义对象</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//获得指向该类所有属性的指针</span></span><br><span class="line">    objc_property_t *properties = class_copyPropertyList([Person class], &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i =<span class="number">0</span>; i &lt; count; i ++) &#123;</span><br><span class="line">        objc_property_t property = properties[i];</span><br><span class="line">        <span class="comment">//根据objc_property_t获得其属性的名称---&gt;C语言的字符串</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *name = property_getName(property);</span><br><span class="line">        <span class="built_in">NSString</span> *key = [<span class="built_in">NSString</span> stringWithUTF8String:name];</span><br><span class="line">        <span class="comment">//解码每个属性,利用kVC取出每个属性对应的数值</span></span><br><span class="line">        [<span class="keyword">self</span> setValue:[decoder decodeObjectForKey:key] forKeyPath:key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="五-_字典转模型">五. 字典转模型</h5><p>需求：能不能自动根据一个字典，生成对应的属性。</p>
<ul>
<li>思路一：KVC。通过KVC方法<code>setValuesForKeysWithDictionary</code>可以进行转换。<ul>
<li>弊端：必须保证模型中的属性和字典中的key一一对应。<ul>
<li>如果不一致，就会调用<code>[&lt;Status 0x7fa74b545d60&gt; setValue:forUndefinedKey:]</code>报key找不到的错。</li>
<li>分析:模型中的属性和字典的key不一一对应，系统就会调用setValue:forUndefinedKey:报错。</li>
<li>解决:重写对象的setValue:forUndefinedKey:,把系统的方法覆盖， 就能继续使用KVC，字典转模型了。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>思路二：RunTime。利用运行时，遍历模型中所有属性，根据模型的属性名，去字典中查找key，取出对应的值，给模型的属性赋值。</p>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">Model</span>)</span></span><br><span class="line"></span><br><span class="line">+ (instancetype)modelWithDict:(<span class="built_in">NSDictionary</span> *)dict</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 思路：遍历模型中所有属性-》使用运行时</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 0.创建对应的对象</span></span><br><span class="line">    <span class="keyword">id</span> objc = [[<span class="keyword">self</span> alloc] init];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 1.利用runtime给对象中的成员属性赋值</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// class_copyIvarList:获取类中的所有成员属性</span></span><br><span class="line">    <span class="comment">// Ivar：成员属性的意思</span></span><br><span class="line">    <span class="comment">// 第一个参数：表示获取哪个类中的成员属性</span></span><br><span class="line">    <span class="comment">// 第二个参数：表示这个类有多少成员属性，传入一个Int变量地址，会自动给这个变量赋值</span></span><br><span class="line">    <span class="comment">// 返回值Ivar *：指的是一个ivar数组，会把所有成员属性放在一个数组中，通过返回的数组就能全部获取到。</span></span><br><span class="line">    <span class="comment">/* 类似下面这种写法</span><br><span class="line">     </span><br><span class="line">     Ivar ivar;</span><br><span class="line">     Ivar ivar1;</span><br><span class="line">     Ivar ivar2;</span><br><span class="line">     // 定义一个ivar的数组a</span><br><span class="line">     Ivar a[] = &#123;ivar,ivar1,ivar2&#125;;</span><br><span class="line">     </span><br><span class="line">     // 用一个Ivar *指针指向数组第一个元素</span><br><span class="line">     Ivar *ivarList = a;</span><br><span class="line">     </span><br><span class="line">     // 根据指针访问数组第一个元素</span><br><span class="line">     ivarList[0];</span><br><span class="line">     </span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取类中的所有成员属性</span></span><br><span class="line">    Ivar *ivarList = class_copyIvarList(<span class="keyword">self</span>, &amp;count);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        <span class="comment">// 根据角标，从数组取出对应的成员属性</span></span><br><span class="line">        Ivar ivar = ivarList[i];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 获取成员属性名</span></span><br><span class="line">        <span class="built_in">NSString</span> *name = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getName(ivar)];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 处理成员属性名-&gt;字典中的key</span></span><br><span class="line">        <span class="comment">// 从第一个角标开始截取</span></span><br><span class="line">        <span class="built_in">NSString</span> *key = [name substringFromIndex:<span class="number">1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据成员属性名去字典中查找对应的value</span></span><br><span class="line">        <span class="keyword">id</span> value = dict[key];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 二级转换:如果字典中还有字典，也需要把对应的字典转换成模型</span></span><br><span class="line">        <span class="comment">// 判断下value是否是字典</span></span><br><span class="line">        <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSDictionary</span> class]]) &#123;</span><br><span class="line">            <span class="comment">// 字典转模型</span></span><br><span class="line">            <span class="comment">// 获取模型的类对象，调用modelWithDict</span></span><br><span class="line">            <span class="comment">// 模型的类名已知，就是成员属性的类型</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 获取成员属性类型</span></span><br><span class="line">            <span class="built_in">NSString</span> *type = [<span class="built_in">NSString</span> stringWithUTF8String:ivar_getTypeEncoding(ivar)];</span><br><span class="line">            <span class="comment">// 生成的是这种@"@\"User\"" 类型 -》 @"User"  在OC字符串中 \" -&gt; "，\是转义的意思，不占用字符</span></span><br><span class="line">            <span class="comment">// 裁剪类型字符串</span></span><br><span class="line">            <span class="built_in">NSRange</span> range = [type rangeOfString:<span class="string">@"\""</span>];</span><br><span class="line">            </span><br><span class="line">            type = [type substringFromIndex:range<span class="variable">.location</span> + range<span class="variable">.length</span>];</span><br><span class="line">            </span><br><span class="line">            range = [type rangeOfString:<span class="string">@"\""</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 裁剪到哪个角标，不包括当前角标</span></span><br><span class="line">            type = [type substringToIndex:range<span class="variable">.location</span>];</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 根据字符串类名生成类对象</span></span><br><span class="line">            Class modelClass = <span class="built_in">NSClassFromString</span>(type);</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (modelClass) &#123; <span class="comment">// 有对应的模型才需要转</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 把字典转模型</span></span><br><span class="line">                value  =  [modelClass modelWithDict:value];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 三级转换：NSArray中也是字典，把数组中的字典转换成模型.</span></span><br><span class="line">        <span class="comment">// 判断值是否是数组</span></span><br><span class="line">        <span class="keyword">if</span> ([value isKindOfClass:[<span class="built_in">NSArray</span> class]]) &#123;</span><br><span class="line">            <span class="comment">// 判断对应类有没有实现字典数组转模型数组的协议</span></span><br><span class="line">            <span class="keyword">if</span> ([<span class="keyword">self</span> respondsToSelector:<span class="keyword">@selector</span>(arrayContainModelClass)]) &#123;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 转换成id类型，就能调用任何对象的方法</span></span><br><span class="line">                <span class="keyword">id</span> idSelf = <span class="keyword">self</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 获取数组中字典对应的模型</span></span><br><span class="line">                <span class="built_in">NSString</span> *type =  [idSelf arrayContainModelClass][key];</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 生成模型</span></span><br><span class="line">                Class classModel = <span class="built_in">NSClassFromString</span>(type);</span><br><span class="line">                <span class="built_in">NSMutableArray</span> *arrM = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">                <span class="comment">// 遍历字典数组，生成模型数组</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">NSDictionary</span> *dict <span class="keyword">in</span> value) &#123;</span><br><span class="line">                    <span class="comment">// 字典转模型</span></span><br><span class="line">                    <span class="keyword">id</span> model =  [classModel modelWithDict:dict];</span><br><span class="line">                    [arrM addObject:model];</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// 把模型数组赋值给value</span></span><br><span class="line">                value = arrM;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (value) &#123; <span class="comment">// 有值，才需要给模型的属性赋值</span></span><br><span class="line">            <span class="comment">// 利用KVC给模型中的属性赋值</span></span><br><span class="line">            [objc setValue:value forKey:key];</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> objc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<h4 id="Swift_Runtime">Swift Runtime</h4><ul>
<li>纯Swift的类，不能通过runtime获取到属性与方法。比如tuple：纯Swift类的函数调用已经不再是OC的运行时发消息objc_msgsend，而是类似C++的vtable，在编译时就确定了调用什么函数，所以runtime获取不到。</li>
<li>继承于NSObject的类依然拥有动态性，所以可以拿的到。</li>
<li>@objc<ul>
<li>@objc是用来将Swift的API导出给OC与OC runtime使用的，如果你继承NSObject的类，将会被自动的加入这个标识。</li>
</ul>
</li>
<li>dynamic<ul>
<li>加了@objc标识的方法、属性都无法保证都会被运行时调用，因为Swift会做静态优化。要想完全被动态调用就要使用dynamic修饰词了。使用这个标识也会隐形的加入@objc。这也就解释了为什么上边VC中的方法无法被替换了，被Swift优化成静态调用了，而ViewDidAppear本身为OC的方法，拥有动态特性，所以我们加入dynamic关键字</li>
</ul>
</li>
</ul>
<h4 id="小结">小结</h4><ul>
<li>Runtime是运行时特性 ，方法调用的本质是给对象发消息：<code>objc_msgSend</code></li>
<li><strong>class_getClassMethod</strong>: 获取类方法地址</li>
<li><strong>class_getInstanceMethod</strong>: 获取实例方法地址</li>
<li><strong>method_exchangeImplementations</strong>：交换方法的实现</li>
<li><strong><code>+ (BOOL)resolveInstanceMethod:(SEL)sel</code></strong>: 当一个对象调用未实现的方法，会调用这个方法处理,并且会把对应的方法列表传过来.</li>
<li><strong>class_addMethod</strong>：给实例添加方法</li>
<li><strong>objc_setAssociatedObject</strong>：给对象设置关联值</li>
<li><strong>objc_getAssociatedObject</strong>：获取对象的关联值</li>
<li><strong>class_copyPropertyList</strong>：获得指向该类所有属性的指针</li>
<li><strong>property_getName</strong>：取出属性指针对应的名称，返回字符串(char*)</li>
<li><strong>class_copyIvarList</strong>：获取指向该类所有成员属性指针</li>
<li><strong>ivar_getName</strong>：取出成员属性对应的名称</li>
</ul>
<h4 id="参考">参考</h4><p>Runtime简介： <a href="http://www.jianshu.com/p/94657b7d31d0" target="_blank" rel="external">http://www.jianshu.com/p/94657b7d31d0</a><br>Swift Runtime: <a href="http://www.jianshu.com/p/9c36a5b7820a" target="_blank" rel="external">http://www.jianshu.com/p/9c36a5b7820a</a><br>MJExtension: <a href="https://github.com/CoderMJLee/MJExtension" target="_blank" rel="external">https://github.com/CoderMJLee/MJExtension</a></p>
<h2 id="SourceTree_rebase_用法_-_曾铭">SourceTree rebase 用法 - 曾铭</h2><h4 id="push_with_-rebase">push with <code>--rebase</code></h4><h4 id="push_前调整本地的_commits_tree">push 前调整本地的 commits tree</h4><ul>
<li>Add some commits append to the branch</li>
<li>Right-click on a commit and hit <code>Rebase children of &lt;commit-id&gt; interactively...</code></li>
<li>Try <code>reorder</code> or <code>squash</code> or <code>edit message</code> or <code>delete</code></li>
<li>Click <code>OK</code></li>
<li>Enjoy <code>the history tree</code></li>
</ul>
<blockquote>
<p>注意:</p>
<ul>
<li>仅适用于 local branch 还没有 push 的情况!!!</li>
<li>push 时不要使用 <code>-f</code> 参数</li>
</ul>
</blockquote>
<h4 id="参考-1">参考</h4><ul>
<li><a href="http://gitbook.liuhui998.com/4_2.html" target="_blank" rel="external">Git Book 中文版 - rebase</a></li>
<li><a href="https://segmentfault.com/q/1010000000430041" target="_blank" rel="external">团队开发里频繁使用 git rebase 来保持树的整洁好吗? - SegmentFault</a></li>
<li><a href="https://ihower.tw/blog/archives/8076" target="_blank" rel="external">三個使用版本控制系統的建議 | ihower { blogging }</a> 推荐此人博客</li>
<li><a href="http://blogs.atlassian.com/2014/06/interactive-rebase-sourcetree/" target="_blank" rel="external">Interactive rebase in SourceTree | Atlassian Blogs</a></li>
</ul>
<h4 id="附带一提">附带一提</h4><ul>
<li>对于同一个 repo, 本地 clone 一份即可, 用 branchs 切换不同状态. 否则每个 repo 都要 sync( pull&amp;push ) 很麻烦</li>
<li>控制写代码的节奏, 半小时整理思路, 小步提交(起来走走喝杯水), 善用 <code>amend last commit</code> 和 <code>rebase</code>, 便于 reviewer 理解</li>
</ul>
<h2 id="Firebase_-_王胜">Firebase - 王胜</h2><p><a href="https://firebase.google.com/" target="_blank" rel="external">Firebase</a>是一个帮助你快速开发高质量的应用程序，增强你的用户基础，并提高盈利能力的移动开发平台。Firebase有很多互补性的功能组成，你可以根据具体需求，找到适用的功能模块搭配使用。</p>
<h3 id="功能介绍">功能介绍</h3><blockquote>
<p>总体功能预览：</p>
</blockquote>
<p><img src="https://lh3.googleusercontent.com/Jp5DG28Mj668TyylbnjcCjNvzh-9-IjxT1IixnKrOziswXJzQZZ8GUpRobmQPba0vvINC8c6GymEni3UYcAX3uLVdHFz0Z_x=s1600" alt="all-feature-preview"></p>
<h4 id="分析功能">分析功能</h4><p>Firebase的核心功能是Firebases分析，一个免费且没有限制的分析解决方案。通过一个统一的Dashboard看板，可以查看用户的行为以及属性的定量分析。同时支持iOS和Android平台：</p>
<ul>
<li>最多可以无限制报告500个时间类型，每一个时间类型可支持25个属性</li>
<li>统一的dashbaord查看用户行为以及跨网络性能分析</li>
<li>人口分布，包括年龄、性别以及位置信息等</li>
<li>提供可导出的BigQuery自定义查询</li>
</ul>
<h4 id="Develop">Develop</h4><p>构建更好的应用程序，并预留接口给开发者。节省关键的开发时间，产出高质量、无bug的应用程序。</p>
<ul>
<li>云端消息<br>提供可靠的跨平台的消息分发和接受通道</li>
<li>认证<br>提供健壮的认证机制</li>
<li>实时数据<br>实时存储和同步应用数据</li>
<li>存储<br>便捷的文件存储</li>
<li>寄主<br>快速分发网络内容</li>
<li>远程配置<br>可远程自定义应用的配置信息</li>
<li>测试Lab<br>提供云端测试功能</li>
<li>Crash报告<br>保证应用的稳定性</li>
</ul>
<h4 id="Grow">Grow</h4><p>在恰当的时机，培养并吸引合适的用户。促进潜在用户的增长。</p>
<ul>
<li>通知<br>恰当的时机吸引用户</li>
<li>App索引<br>驱动有效的搜索流量到你的App</li>
<li>动态链接<br>应用内发送动态链接，引导用户到正确的地方</li>
<li>邀请<br>引导用户分享你的应用程序</li>
<li>AdWords广告<br>通过Google搜索获取用户</li>
</ul>
<h4 id="Earn">Earn</h4><p>通过向全球用户展示吸引的广告赚取到收入。</p>
<ul>
<li>AdMob<br>通过吸引性的广告盈利</li>
</ul>
<h3 id="开发使用">开发使用</h3><h4 id="前置条件">前置条件</h4><ul>
<li>一个运行Google Play服务9.0.0以上版本的Android设备</li>
<li>通过 <a href="https://developer.android.com/tools/help/sdk-manager.html" target="_blank" rel="external">Android SDK Manager</a> 获取Google Play services</li>
<li><a href="http://developer.android.com/sdk" target="_blank" rel="external">Android Studio</a> 1.5或者更高版本</li>
<li>一个Android Studio项目和包名</li>
</ul>
<blockquote>
<p>注意事项：<br>Android Studio低于2.2版本中的Instant Run存在Firebase Analytics和特定事件保护不兼容问题，官方建议禁用 Instant run或者升级Android Studio到2.2预览版。</p>
</blockquote>
<h4 id="创建Firebase项目">创建Firebase项目</h4><ul>
<li>访问 <a href="https://console.firebase.google.com/" target="_blank" rel="external">控制台</a>，创建一个Firebase项目。<br><img src="http://7xsk2b.com1.z0.glb.clouddn.com/image/firebase-create-project.png" alt="firebase-create-projec"></li>
<li>添加Firebase到应用程序<br>选择项目 -&gt; 项目设置 -&gt; 将Firebase添加到您的Android/iOS/网页应用，按照向导一步一步完成配置。<br><img src="http://7xsk2b.com1.z0.glb.clouddn.com/image/firebase-console-dashboard.png" alt="firebase-console-dashboard"><br><img src="http://7xsk2b.com1.z0.glb.clouddn.com/image/firebase-add-to-app.png" alt="firebase-add-to-app"></li>
<li>选择需要的功能模块，加入项目中<br><img src="http://7xsk2b.com1.z0.glb.clouddn.com/image/firebase-feature-libs-list.png" alt="firebase-feature-libs-list"></li>
</ul>
<p>具体的开发文档，<a href="https://firebase.google.com/docs" target="_blank" rel="external">参见官网</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-移动周分享-第55期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/13/移动周分享-第55期/" class="article-date">
  	<time datetime="2016-05-13T10:30:00.000Z" itemprop="datePublished">2016-05-13</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/13/移动周分享-第55期/">移动周分享-第55期</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Android_MVVM开发模式_-_王胜">Android MVVM开发模式 - 王胜</h2><p>MVVM（<a href="https://en.wikipedia.org/wiki/Model_View_ViewModel" target="_blank" rel="external">Model－View－ViewModel</a>），它最初是在2005年由微软提出的一个被证明可用的概念。在Google I/O 2015上，伴随着Android M预览版发布的<a href="https://developer.android.com/tools/data-binding/guide.html" target="_blank" rel="external">Data Binding</a>使Android原生开发也支持了MVVM框架。</p>
<p><img src="https://tech.vg.no/files/2015/07/mvvm.png" alt="mvvm-workflow"></p>
<p>下面还是通过天气的示例来演示MVVM框架的运用，效果如图：<br><img src="http://7xsk2b.com1.z0.glb.clouddn.com/image/weather-app-screenshot.png" alt="weather-app-screenshot"></p>
<h2 id="目录结构">目录结构</h2><p>  <img src="http://7xsk2b.com2.z0.glb.clouddn.com/image/android-mvvm.png" alt="android-mvvm"></p>
<h3 id="开启Data_Binding功能">开启Data Binding功能</h3><p>Android Studio中，在需要开启Data Binding功能的Module中的build.gradle文件中加入以下内容</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 开启Data Binding功能</span></span><br><span class="line">dataBinding &#123;</span><br><span class="line">    enabled <span class="keyword">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Model层_Weather">Model层 Weather</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Weather</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String date;<span class="comment">//日期</span></span><br><span class="line">    <span class="keyword">private</span> String textDay;<span class="comment">//白天天气</span></span><br><span class="line">    <span class="keyword">private</span> String textNight;<span class="comment">//夜晚天气</span></span><br><span class="line">    <span class="keyword">private</span> String high;<span class="comment">//最高气温</span></span><br><span class="line">    <span class="keyword">private</span> String low;<span class="comment">//最低气温</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDisplay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(date);</span><br><span class="line">        sb.append(<span class="string">"\t"</span>);</span><br><span class="line">        sb.append(<span class="string">"白天:"</span>);</span><br><span class="line">        sb.append(textDay);</span><br><span class="line">        sb.append(<span class="string">", "</span>);</span><br><span class="line">        sb.append(<span class="string">"夜晚:"</span>);</span><br><span class="line">        sb.append(textNight);</span><br><span class="line">        sb.append(<span class="string">", "</span>);</span><br><span class="line">        sb.append(<span class="string">"最高气温:"</span>);</span><br><span class="line">        sb.append(high);</span><br><span class="line">        sb.append(<span class="string">", "</span>);</span><br><span class="line">        sb.append(<span class="string">"最低气温:"</span>);</span><br><span class="line">        sb.append(low);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// setter and getter</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="View层">View层</h3><ul>
<li><p>activity_weather_mvvm.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">  <span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">layout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span></span><br><span class="line">        <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:textStyle</span>=<span class="value">"bold"</span></span><br><span class="line">            <span class="attribute">android:textSize</span>=<span class="value">"22sp"</span></span><br><span class="line">            <span class="attribute">android:layout_marginLeft</span>=<span class="value">"@dimen/activity_horizontal_margin"</span></span><br><span class="line">            <span class="attribute">android:text</span>=<span class="value">"上海未来3天的天气"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">ListView</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/lv"</span></span><br><span class="line">            <span class="attribute">android:layout_marginTop</span>=<span class="value">"@dimen/activity_horizontal_margin"</span></span><br><span class="line">            <span class="attribute">android:visibility</span>=<span class="value">"gone"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"match_parent"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">LinearLayout</span></span><br><span class="line">            <span class="attribute">android:id</span>=<span class="value">"@+id/ll_loading"</span></span><br><span class="line">            <span class="attribute">android:layout_marginTop</span>=<span class="value">"100dp"</span></span><br><span class="line">            <span class="attribute">android:layout_width</span>=<span class="value">"match_parent"</span></span><br><span class="line">            <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">            <span class="attribute">android:orientation</span>=<span class="value">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="title">ProgressBar</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">style</span>=<span class="value">"?android:attr/progressBarStyleLarge"</span></span><br><span class="line">                <span class="attribute">android:layout_gravity</span>=<span class="value">"center_horizontal"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">                <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">                <span class="attribute">android:layout_gravity</span>=<span class="value">"center"</span></span><br><span class="line">                <span class="attribute">android:textSize</span>=<span class="value">"20sp"</span></span><br><span class="line">                <span class="attribute">android:text</span>=<span class="value">"@string/loading"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">LinearLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>WeatherActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">WeatherViewModel</span>.<span class="title">DataListener</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ActivityWeatherMvvmBinding binding;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        binding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.activity_weather_mvvm);</span><br><span class="line">        <span class="keyword">new</span> WeatherViewModel(<span class="keyword">this</span>).getWeatherList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onWeatherChanged</span><span class="params">(<span class="keyword">boolean</span> occurError, List&lt;Weather&gt; data)</span> </span>&#123;</span><br><span class="line">        binding.llLoading.setVisibility(View.GONE);</span><br><span class="line">        <span class="keyword">if</span> (occurError) &#123;</span><br><span class="line">            Toast.makeText(WeatherActivity.<span class="keyword">this</span>, <span class="string">"Get data failed!"</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            binding.lv.setAdapter(<span class="keyword">new</span> WeatherAdapter(data));</span><br><span class="line">            binding.lv.setVisibility(View.VISIBLE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>weather_item.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="pi">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="title">layout</span> <span class="attribute">xmlns:android</span>=<span class="value">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="title">variable</span> <span class="attribute">name</span>=<span class="value">"weather"</span> <span class="attribute">type</span>=<span class="value">"org.freedom.androidpatterndemo.mvvm.model.Weather"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="title">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="title">TextView</span></span><br><span class="line">        <span class="attribute">android:id</span>=<span class="value">"@+id/tv_weather"</span></span><br><span class="line">        <span class="attribute">android:paddingLeft</span>=<span class="value">"16dp"</span></span><br><span class="line">        <span class="attribute">android:paddingRight</span>=<span class="value">"16dp"</span></span><br><span class="line">        <span class="attribute">android:layout_width</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:layout_height</span>=<span class="value">"wrap_content"</span></span><br><span class="line">        <span class="attribute">android:textSize</span>=<span class="value">"18sp"</span></span><br><span class="line">        <span class="attribute">android:text</span>=<span class="value">"@&#123;weather.getDisplay&#125;"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="title">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>WeatherAdapter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherAdapter</span> <span class="keyword">extends</span> <span class="title">BaseAdapter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Weather&gt; data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WeatherAdapter</span><span class="params">(List&lt;Weather&gt; data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data == <span class="keyword">null</span> ? <span class="number">0</span> : data.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Weather <span class="title">getItem</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> data.get(position);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getItemId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">getView</span><span class="params">(<span class="keyword">int</span> position, View convertView, ViewGroup viewGroup)</span> </span>&#123;</span><br><span class="line">        ViewHolder holder;</span><br><span class="line">        <span class="keyword">if</span> (convertView == <span class="keyword">null</span>) &#123;</span><br><span class="line">            holder = <span class="keyword">new</span> ViewHolder((WeatherItemBinding) DataBindingUtil.inflate(LayoutInflater.from(viewGroup.getContext()),</span><br><span class="line">                R.layout.weather_item, viewGroup, <span class="keyword">false</span>));</span><br><span class="line">            convertView = holder.binding.tvWeather;</span><br><span class="line">            convertView.setTag(holder);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            holder = (ViewHolder) convertView.getTag();</span><br><span class="line">        &#125;</span><br><span class="line">        holder.binding.setWeather(getItem(position));</span><br><span class="line">        <span class="keyword">return</span> convertView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span> </span>&#123;</span><br><span class="line">        WeatherItemBinding binding;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ViewHolder</span><span class="params">(WeatherItemBinding binding)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.binding = binding;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>WeatherViewModer</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * View model for WeatherActivity</span><br><span class="line"> *</span><br><span class="line"> * 从维基百科文章中可以看到：</span><br><span class="line"> *</span><br><span class="line"> * view model是一个抽象的view，它对外暴露公有的属性和命令。</span><br><span class="line"> *</span><br><span class="line"> * Created by wangsheng on 16/5/12.</span><br><span class="line"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherViewModel</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DataListener dataListener;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WeatherViewModel</span><span class="params">(DataListener dataListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dataListener = dataListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 通过网络请求获取天气列表数据</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getWeatherList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HttpEngine.get(Constants.API_WEATHER, <span class="keyword">new</span> HttpEngine.JSONRequestCallback() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailed</span><span class="params">(Call call, Exception e)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (call.request().url().url().toString().equals(Constants.API_WEATHER)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (dataListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        dataListener.onWeatherChanged(<span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Call call, JSONObject jsonResult)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (call.request().url().url().toString().equals(Constants.API_WEATHER)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        JSONArray jsonArray = jsonResult.getJSONArray(<span class="string">"results"</span>).getJSONObject(<span class="number">0</span>).getJSONArray(<span class="string">"daily"</span>);</span><br><span class="line">                        Gson gson = <span class="keyword">new</span> GsonBuilder().setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES).create();</span><br><span class="line">                        List&lt;Weather&gt; data = gson.fromJson(jsonArray.toString(), <span class="keyword">new</span> TypeToken&lt;List&lt;Weather&gt;&gt;()&#123;&#125;.getType());</span><br><span class="line">                        <span class="keyword">if</span> (dataListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            dataListener.onWeatherChanged(<span class="keyword">false</span>, data);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        <span class="keyword">if</span> (dataListener != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            dataListener.onWeatherChanged(<span class="keyword">true</span>, <span class="keyword">null</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onWeatherChanged</span><span class="params">(<span class="keyword">boolean</span> occurError, List&lt;Weather&gt; data)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结">总结</h3><p>通过上面可以看出，ViewModer代替了原来的Presenter，不过相比于MVP，MVVM的Data Binding框架做了数据和View的自动绑定功能，省去了手动findViewById以及拿到组件后set数据的繁琐步骤。</p>
<h2 id="从计算机为什么用补码存储数据，衍生到存储单元数据溢出_-_李仙鹏">从计算机为什么用补码存储数据，衍生到存储单元数据溢出 - 李仙鹏</h2><h3 id="引言">引言</h3><blockquote>
<p>先说几句屁话，觉得啰嗦可以忽略跳过这段屁话。<br>俗话说：眼看他起高楼，眼看他宴宾客，眼看他楼塌了。我想这句话放在我们做技术的，也很合适——基础不牢，地动山摇。<br>尽管我们很多人不是做基础开发的，但是操作系统、数据结构和算法、计算机网络、设计模式……这些IT领域的基础性学科，对于我们来说其实挺重要的，比如做优化、跨语言学习、工程框架搭建……。基础虽然不能决定眼前，但是能够决定我们在这条路上走多远。框架那么多、特效那么多，真心没有兴趣一个个都摸一遍，所以偶尔回过头去翻看这些基础性的东西是挺有意思的。</p>
</blockquote>
<ul>
<li>是否还记得在学操作系统的时候，很困惑计算机为什么要用补码存储数据，而不是用我们人更容易理解的原码来进行存储呢？</li>
</ul>
<blockquote>
<p>关于这个问题，相信很多教这门课的老师以及工作多年的coder也解释不清，甚至不知道这个概念。</p>
</blockquote>
<ul>
<li>本文将尝试从理性结合感性的角度去说明<strong><em>计算机为什么用补码存储数据</em></strong>，当我们明白这个问题后，那么，我们就可以去理解另一个衍生问题——<strong><em>数据溢出</em></strong>。我们先来看一段关于数据溢出的Java代码片：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*char为无符号数，16位存储，表示范围是0～2^16-1（即0～65535）*/</span></span><br><span class="line"><span class="keyword">char</span> ch = Character.MAX_VALUE; <span class="comment">// ch为65535</span></span><br><span class="line">ch += (<span class="keyword">char</span>) <span class="number">1</span>; <span class="comment">// 加1后，引起数据溢出，则ch为0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*int位有符号数，32位存储，表示范围是－2^31~2^31-1（即－2147483648～2147483647）*/</span></span><br><span class="line"><span class="keyword">int</span> i = Integer.MAX_VALUE; <span class="comment">// i为2147483647</span></span><br><span class="line">i += <span class="number">1</span>; <span class="comment">// 加1后，引起数据溢出，则i为－2147483648</span></span><br></pre></td></tr></table></figure>
<ul>
<li>至于上述代码片的执行结果为什么会这样，暂时不解释，希望通过文章循序渐进的过程来说明溢出的问题。</li>
</ul>
<h3 id="fuck概念">fuck概念</h3><ul>
<li>计算机用二进制来表示数据，这个大家应该都了解（不了解的找块板砖拍死自己算了）。</li>
</ul>
<blockquote>
<ul>
<li>没有特殊说明，本文都以4位存储单元来说明</li>
<li>下面几个小节会提到一些关键概念，不要对这些概念恐慌，这些概念会结合例子或者对比的形式，尽量以通俗简洁的文字来说明，保证人人都能看的懂</li>
</ul>
</blockquote>
<h4 id="加法器">加法器</h4><ul>
<li>计算机只有加法器没有减法器，两个数的减法运算会被计算机转换为加法运算。（先埋个伏笔——通过补码进行表示，即可将减法运算转换为加法运算）</li>
</ul>
<h4 id="模、补数">模、补数</h4><ul>
<li><p>在日常生活中，有许多化减为加点例子。我们以最平常的钟表为例，时针逆时针拨x（0&lt;x&lt;12）格和时针顺时针拨12-x格，效果是相同的。比如，时针从10点调整到5点有以下两种方法：</p>
<ol>
<li>时针逆时针拨5格，相当于做减法：10 -5 = 5</li>
<li>时针顺时针拨7（即12 - 5）格，相当于做加法：10 + 7 = 12 +5 = 5（MOD＝12）</li>
</ol>
</li>
<li><p>总结，x + (MOD - x) = MOD就是模，x和MOD - x就是一对“互补”的数，即原数x的补数为MOD - x或者原数MOD - x的补数为x。通过对钟表拨时针的例子可以发现，用补数（7）代替原数（5），可把减法转变为加法（出现的进位就是模，进位舍弃）。</p>
</li>
</ul>
<blockquote>
<p>二进制数的模，先来看下两个个例子（此处我们忽略符号）：</p>
<ol>
<li>2位存储所能表示的最大数是11（10进制：3 = 2^2 - 1），比他大1的是11 + 1 = 100（10进制：4 = 2^2），那么这个100则是2位存储所能表示的所有数据的模。</li>
<li>4位存储所能表示的最大数是1111（10进制：15 = 2^4 - 1），比他大1的数是1111 + 1 = 10000（10进制：16 = 2^4），那么这个10000则是4位存储所能表示的所有数据的模。</li>
</ol>
<p>通过对上面两个例子可以推论：<strong><em>一个二进制数的最高位位数用n表示，那么该二进制数的模就是2^n</em></strong>。</p>
</blockquote>
<h4 id="原码、反码、补码">原码、反码、补码</h4><ul>
<li>先来看一张国内外教材对比的表（出自《计算机教育》2015年第10期的文章——《原码、反码和补码的教学讨论》）</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1510997-e2ea5fb9d6fc3f5a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="国内外教材对比.png"></p>
<ul>
<li><p>给定一个有符号数x，来对比下国外和国内教材对原码、反码、补码的表示：</p>
<ul>
<li>国外教材<ul>
<li>sign and magnitude representation（原码）：最高位位符号位（0表示正数，1表示负数），剩余位（数据位）为x的大小。</li>
<li>ones’ complement representation（反码）：如果x为正数，则是其二进制表示；如果x为负数，则是其对应正数的bit complement/bitwise NOT（按位取反）——执行每一位逻辑否定的一元操作。可用公式表示为：<ul>
<li><strong><em>[x]反 = (2^n - 1) - |X|（其中n为将符号位算在内的位数，|X|为绝对值）</em></strong></li>
</ul>
</li>
<li>two’s complement representation（补码）：如果x为正数，则是其二进制表示；如果x为负数，则是其对应正数的二的补（所有位取反后加1）。可用公式表示为：<ul>
<li><strong><em>[x]补 = (2^n) - |X| ＝ [x]反 + 1（其中n为将符号位算在内的位数，|X|为绝对值）</em></strong></li>
</ul>
</li>
</ul>
</li>
<li>国内教材<ul>
<li>原码：最高位为符号位，剩余位（数据位）为x的绝对值。</li>
<li>反码：如果x为正数，则与原码相同；如果x为负数，符号位保持不变，数据位取反。</li>
<li>补码：如果x为正数，则与原码相同；如果x为负数，符号位保持不变，数据位取反，然后加1（若符号位有进位，则舍弃进位）。</li>
</ul>
</li>
</ul>
</li>
<li><p>对比国内外教材的表述，是否发现高下立现：</p>
<ul>
<li>国内教材画蛇添足，并且容易引起误解：<ol>
<li><strong><em><del>原码是反码和补码的基础，反码和补码由原码转化而来</del></em></strong></li>
<li><strong><em><del>原码、反码和补码的符号位相同</del></em></strong></li>
</ol>
</li>
<li>国外教材，则非常通俗：<ol>
<li><strong><em>求解一个数的反码和补码，根本不需要知道原码，直接通过它们的两个对应公式即可，甚至可以说原码与反码和补码没有半毛钱关系，反倒是反码和补码存在关系——补码 = 反码 + 1</em></strong></li>
<li><strong><em>原码的出发点是符号的表示（符号位），即用0表示正数，用1表示负数；反码和补码的出发点是减法的运算，即用两个正数的加法取代两个数的减法</em></strong></li>
</ol>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>狗日的国内教材和翻译，真是误人子弟啊</p>
</blockquote>
<h3 id="计算机为什么用补码存储数据">计算机为什么用补码存储数据</h3><ul>
<li>上面铺垫了这门久，终于要进入第一个正题——计算机为什么用补码存储数据。为了不引起混淆，我们就以国外教材对于原码、反码和补码的表示法来进行说明。简单起见，以4位存储表示有符号数为例，通过原码、反码和补码的表示法来生成一张表：</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">有符号数（十进制）</th>
<th style="text-align:center">sign and magnitude representation（原码）</th>
<th style="text-align:center">ones’ complement representation（反码），[x]反 = (2^n - 1) - \X\</th>
<th style="text-align:center">two’s complement representation（补码），[x]补 = (2^n) - \X\</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">+7</td>
<td style="text-align:center">0111</td>
<td style="text-align:center">表示方式不变</td>
<td style="text-align:center">表示方式不变</td>
</tr>
<tr>
<td style="text-align:center">+6</td>
<td style="text-align:center">0110</td>
<td style="text-align:center">表示方式不变</td>
<td style="text-align:center">表示方式不变</td>
</tr>
<tr>
<td style="text-align:center">+5</td>
<td style="text-align:center">0101</td>
<td style="text-align:center">表示方式不变</td>
<td style="text-align:center">表示方式不变</td>
</tr>
<tr>
<td style="text-align:center">+4</td>
<td style="text-align:center">0100</td>
<td style="text-align:center">表示方式不变</td>
<td style="text-align:center">表示方式不变</td>
</tr>
<tr>
<td style="text-align:center">+3</td>
<td style="text-align:center">0011</td>
<td style="text-align:center">表示方式不变</td>
<td style="text-align:center">表示方式不变</td>
</tr>
<tr>
<td style="text-align:center">+2</td>
<td style="text-align:center">0010</td>
<td style="text-align:center">表示方式不变</td>
<td style="text-align:center">表示方式不变</td>
</tr>
<tr>
<td style="text-align:center">+1</td>
<td style="text-align:center">0001</td>
<td style="text-align:center">表示方式不变</td>
<td style="text-align:center">表示方式不变</td>
</tr>
<tr>
<td style="text-align:center">+0</td>
<td style="text-align:center">0000</td>
<td style="text-align:center">表示方式不变</td>
<td style="text-align:center">表示方式不变</td>
</tr>
<tr>
<td style="text-align:center">-0</td>
<td style="text-align:center">1000</td>
<td style="text-align:center">1111</td>
<td style="text-align:center">0000（求解过程：[x]补 = 2^n - \x\ = 2^4 - \-0\ = 2^4 - (+0)，使用二进制则为10000 - 0000 = 10000，超过4位（有进位），那么舍弃进位1，最终结果就是0000）</td>
</tr>
<tr>
<td style="text-align:center">-1</td>
<td style="text-align:center">1001</td>
<td style="text-align:center">1110</td>
<td style="text-align:center">1111</td>
</tr>
<tr>
<td style="text-align:center">-2</td>
<td style="text-align:center">1010</td>
<td style="text-align:center">1101</td>
<td style="text-align:center">1110</td>
</tr>
<tr>
<td style="text-align:center">-3</td>
<td style="text-align:center">1011</td>
<td style="text-align:center">1100</td>
<td style="text-align:center">1101</td>
</tr>
<tr>
<td style="text-align:center">-4</td>
<td style="text-align:center">1100</td>
<td style="text-align:center">1011</td>
<td style="text-align:center">1100</td>
</tr>
<tr>
<td style="text-align:center">-5</td>
<td style="text-align:center">1101</td>
<td style="text-align:center">1010</td>
<td style="text-align:center">1011</td>
</tr>
<tr>
<td style="text-align:center">-6</td>
<td style="text-align:center">1110</td>
<td style="text-align:center">1001</td>
<td style="text-align:center">1010</td>
</tr>
<tr>
<td style="text-align:center">-7</td>
<td style="text-align:center">1111</td>
<td style="text-align:center">1000</td>
<td style="text-align:center">1001</td>
</tr>
<tr>
<td style="text-align:center">-8</td>
<td style="text-align:center">超出4个bit所能表达范围</td>
<td style="text-align:center">超出4个bit所能表达范围</td>
<td style="text-align:center">1000</td>
</tr>
<tr>
<td style="text-align:center">备注</td>
<td style="text-align:center">零重码，二进制存在两种表示方法：0000和1000</td>
<td style="text-align:center">零重码，二进制存在两种表示方法：0000和1111</td>
<td style="text-align:center">零无重码，同时解决了原码和反码不能表示-8的问题</td>
</tr>
</tbody>
</table>
<ul>
<li><p>通过上述表格，可以很自然的总结出一个结论：<strong><em>补码表示法（two’s complement representation）可以防止0的机器数重码，同时又解决了原码和反码无法表示－8的问题</em></strong>，这样就极大的简化了计算机的硬件设计。</p>
</li>
<li><p>结合之前提到的时钟例子，我们把补码表示法（two’s complement representation）所表示的四位存储单元，按照从0000到1111递增的方式，均匀的分布在时钟的表盘上。于是，我们就可以得到下面这张图（图片来自于<a href="http://users.dickinson.edu/~braught/courses/cs251f02/classes/notes07.html" target="_blank" rel="external">这里</a>）：</p>
</li>
</ul>
<p><img src="http://upload-images.jianshu.io/upload_images/1510997-54e3b1cb3e8e626b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="two&#39;s complement wheel"></p>
<ul>
<li><p>OK，继续以时钟的方式来观察上图：</p>
<ul>
<li><strong><em>顺时针方向位加法，逆时针方向为减法</em></strong></li>
<li><strong><em>模为2^n</em></strong>：在1111处顺时针拨一格，就到了0000。用数学的方式，即1111 + 1 = 10000，进位舍弃则结果为0000，那么四位存储的模就是10000（2^4）</li>
<li><strong><em>减法转换为加法</em></strong>：3 - 1 = 3 + （-1） = 0011 + 1111 = 0010，眼尖的人可能会说0011 + 1111明明等于10010，怎么会是0010？还记得之前提过的最高位进位舍弃嘛，因此对于4位存储来说，进位舍弃后就是0010 = 2。<blockquote>
<p>若减法不转换为加法，那么3 -1 = 0011 - 0001 = 0010 = 2</p>
</blockquote>
</li>
<li><strong><em>数据溢出</em></strong>：当0111（7）加1时，按照我们人的思维来说，应该结果为8，但是对于机器来说则不是，0111（7）是四位存储所能表示的最大数，它是无法表示01111（8）的，这个时候我们就说数据溢出了。那么数据溢出该怎么办呢？很简单，机器的思考方式显然和我们人脑不一样，机器按照上面环形图的方式，由于0111（7）加1是顺时针造成的数据溢出，那么我们可以把机器的操作想象成在0111（7）处顺时针拨了一格，我们再去对照下环形图发现这时候指向了1000（－8）。<blockquote>
<p>把这个过程想象成拨时针就OK了，对于1000（－8）减1也是同样道理</p>
</blockquote>
</li>
</ul>
</li>
<li><p>至此，我们完全可以总结一下，并解答计算机为什么用补码存储数据：</p>
<ol>
<li><strong><em>计算机只有加法器没有减法器，两个数的减法运算会被计算机转换为加法运算，而补码正好能够解决减法转换为加法的问题</em></strong></li>
<li><strong><em>防止机器发生零重码，同时解决了原码和反码不能表示-8的问题，这样极大的简化了计算机的硬件设计</em></strong></li>
<li><strong><em>以循环的方式解决数据溢出的问题</em></strong></li>
</ol>
</li>
</ul>
<h3 id="从补码的角度解答代码片中的数据溢出">从补码的角度解答代码片中的数据溢出</h3><ul>
<li><p>既然已经知道了计算机为什么用补码存储数据，那我们就可以回过头去消灭文章开头的数据溢出的代码片了。由于代码片中ch和i的问题是一样的，那我们就选择ch来进行分析，另一个留给你们分析。</p>
</li>
<li><p>在Java中，char为无符号数，16位存储，表示范围是0～2^16-1（即0～65535）。</p>
<ol>
<li>首先，我们按照0000 0000 0000 0000到1111 1111 1111 1111递增的方式，均匀的分布在时钟的表盘上，图就不画了，自己在脑中想象一下或者画个草稿。</li>
<li>然后，找出数据溢出点，通过观察char环形图可以发现数据溢出点是0（0000 0000 0000 0000）和65535（1111 1111 1111 1111）</li>
<li>最后，我们的ch = 65535 + 1，那么很显然发生了数据溢出，按照拨时针的方式就可以得出ch = 0</li>
</ol>
</li>
<li><p>Perfect，是否解答了当初学操作系统和编程的时候，困扰你们很久的问题。送给大家一句话：有些概念可能当时不理解，但是随着经验多累积和回顾的多了，自然而然就理解了。</p>
</li>
</ul>
<blockquote>
<p>贴出我看的关于补码的文章链接，有几篇中文文章对于某些知识点可能说错了，切记要带着批判的观点去看：</p>
</blockquote>
<ul>
<li>《深入理解计算机系统》第二章</li>
<li>《计算机教育》2015年第10期的文章——《原码、反码和补码的教学讨论》</li>
<li><a href="http://wenku.baidu.com/link?url=wayiLiKLswqXsZycoidDK2CHH_SRwW9cnWTr9Nmds_Gw1HkkX3aygtchh7mEZWYg2MnHoMUEim5bGCp839NPlhqoqTGX20CCNjAErJY0CKG" target="_blank" rel="external">补码原理的个人理解</a></li>
<li><a href="http://www.360doc.com/content/12/1009/21/10086564_240513741.shtml" target="_blank" rel="external">为什么计算机用补码存储数据？</a></li>
<li><a href="https://www.douban.com/note/223507364/" target="_blank" rel="external">原码、反码和补码</a></li>
<li><a href="http://baike.baidu.com/link?url=ZcIzYnFGWCC7a4gbpAVow0F981p3hPW4esDXi6uA5Uee0ovhblfp8gOvDzN-HQiJgdgGAhRuVMay9ZpdB8OS2q#reference-[1]-377340-wrap" target="_blank" rel="external">补码</a></li>
<li><a href="http://users.dickinson.edu/~braught/courses/cs251f02/classes/notes07.html" target="_blank" rel="external">Class #7 - Signed Binary Numbers, Subtraction and Overflow</a>　　</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-移动周分享-第54期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/05/06/移动周分享-第54期/" class="article-date">
  	<time datetime="2016-05-06T10:30:00.000Z" itemprop="datePublished">2016-05-06</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/06/移动周分享-第54期/">移动周分享-第54期</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="自动化_ssh_授权笔记_-_曾铭">自动化 ssh 授权笔记 - 曾铭</h2><p>每次 <code>ssh user@host</code> 登录目标机器都要输密码是件很烦的事，特别是经常访问多台主机的情况。 最近写自动化脚本时碰到要自动做机器间 ssh 验证，碰到一些问题记录下来备忘。</p>
<h3 id="分析">分析</h3><ul>
<li>通过 <code>ssh-keygen -t rsa -b 4096 -C &quot;your_email@example.com&quot;</code> 命令生成本地机器的私钥和公钥: <code>~/.ssh/id_rsa</code> and <code>~/.ssh/id_rsa.pub</code></li>
<li>授权就是将将本地机器的公钥加入到目标机器的 <code>~/.ssh/authorized_keys</code> 中供验证用</li>
<li>本地 <code>~/.ssh/known_hosts</code> 中信任目标机器的公钥指纹</li>
</ul>
<h3 id="自动做_ssh-key_授权">自动做 ssh-key 授权</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># copy local ssh-key to remote 对应分析中的第二步</span></span><br><span class="line">cat ~<span class="regexp">/.ssh/id</span>_rsa.pub | ssh root<span class="variable">@192</span>.<span class="number">168.37</span>.<span class="number">110</span> <span class="string">"cat &gt;&gt; ~/.ssh/authorized_keys"</span></span><br><span class="line"><span class="comment"># add host to known_hosts 对应分析中的第三步</span></span><br><span class="line">ssh-keyscan -t rsa <span class="string">"192.168.37.110"</span> <span class="prompt">&gt;&gt; </span>~<span class="regexp">/.ssh/known</span>_hosts</span><br></pre></td></tr></table></figure>
<p>或者这两条命令可以精简为如下一条</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew install ssh-<span class="keyword">copy</span>-<span class="property">id</span> <span class="comment"># just for mac</span></span><br><span class="line">ssh-<span class="keyword">copy</span>-<span class="property">id</span> -i ~/.ssh/id_rsa.pub root@<span class="number">192.168</span>.37.110</span><br></pre></td></tr></table></figure>
<p>还有剩下的一个难题是还需要手动输入密码，这个怎么自动化呢？</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># just for mac</span></span><br><span class="line">brew install <span class="symbol">https:</span>/<span class="regexp">/raw.githubusercontent.com/kadwanev</span><span class="regexp">/bigboybrew/master</span><span class="regexp">/Library/</span><span class="constant">Formula/</span>sshpass.rb </span><br><span class="line">sshpass -p <span class="string">"PASSWORD"</span> ssh-copy-id -i ~<span class="regexp">/.ssh/id</span>_rsa.pub -o <span class="constant">StrictHostKeyChecking=</span>no root<span class="variable">@192</span>.<span class="number">168.37</span>.<span class="number">110</span></span><br></pre></td></tr></table></figure>
<p>或者使用 Fabric 等远程执行 run(“cmd”)</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor"># tips 执行 sudo 不需要手动输入密码</span></span><br><span class="line">echo <span class="string">"PASSWORD"</span> <span class="string">| sudo -S CMD</span></span><br></pre></td></tr></table></figure>
<p>用 iterm2 做 terminal 管理<br>略</p>
<p>参考:</p>
<ul>
<li><a href="http://www.ruanyifeng.com/blog/2011/12/ssh_remote_login.html" target="_blank" rel="external">SSH原理与运用（一）：远程登录 - 阮一峰的网络日志</a></li>
<li><a href="http://www.ibm.com/developerworks/cn/aix/library/au-sshsecurity/" target="_blank" rel="external">SSH 安全性和配置入门</a></li>
</ul>
<h2 id="枚举的特殊用法_-_杨志平">枚举的特殊用法 - 杨志平</h2><blockquote>
<p>源于项目中的应用太广了，但是对swift的很多简单特性不熟。之前那个动画的<code>阶段</code>使用到enum有遇到困难暂时绕开它了</p>
</blockquote>
<p><code>当时的目标就是外部直接赋值操作</code></p>
<h3 id="如下动画的enum示例：">如下动画的enum示例：</h3><blockquote>
<p>为了省事，目前直接使用死的文案放在这里</p>
</blockquote>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">AnimationPeriod</span>: <span class="title">UInt</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 动画执行的五个阶段</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">Start</span>,<span class="type">First</span>,<span class="type">Second</span>,<span class="type">Third</span>,<span class="type">End</span></span><br><span class="line">    </span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">description</span><span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Start</span>, .<span class="type">First</span>:    <span class="keyword">return</span> <span class="string">"正在提取学校最新\n录取条件"</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Second</span>:           <span class="keyword">return</span> <span class="string">"正在与学校进行匹配"</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Third</span>, .<span class="type">End</span>:      <span class="keyword">return</span> <span class="string">"正在根据匹配结果\n生成选校方案"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">duration</span><span class="params">()</span></span> -&gt; <span class="type">NSTimeInterval</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Start</span>:    <span class="keyword">return</span> <span class="number">0.8</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">First</span>:    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Second</span>:   <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Third</span>:    <span class="keyword">return</span> <span class="number">0.5</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">End</span>:      <span class="keyword">return</span> <span class="number">0.25</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">AnimationPeriod</span> </span>&#123;</span><br><span class="line">    <span class="keyword">mutating</span> <span class="func"><span class="keyword">func</span> <span class="title">next</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Start</span>:    <span class="keyword">self</span> = .<span class="type">First</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">First</span>:    <span class="keyword">self</span> = .<span class="type">Second</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Second</span>:   <span class="keyword">self</span> = .<span class="type">Third</span></span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Third</span>:    <span class="keyword">self</span> = .<span class="type">End</span></span><br><span class="line">        <span class="keyword">default</span>:        <span class="keyword">self</span> = .<span class="type">End</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="下面我们看看一些枚举的使用">下面我们看看一些枚举的使用</h3><p>携带<code>参数</code></p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">FamilyType</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">case</span> <span class="type">Father</span>(age: <span class="type">Int</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Mother</span>(age: <span class="type">Int</span>)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Sister</span>(age: <span class="type">Int</span>)</span><br><span class="line"></span><br><span class="line">    <span class="func"><span class="keyword">func</span> <span class="title">gift</span><span class="params">()</span></span> -&gt; <span class="type">String</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span>(<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Sister</span>(<span class="keyword">let</span> age):</span><br><span class="line">            <span class="keyword">if</span> age &gt; <span class="number">15</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"iphone"</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">"toy"</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">case</span> .<span class="type">Mother</span>(<span class="keyword">let</span> age) <span class="keyword">where</span> age &lt; <span class="number">40</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"cloth"</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"book"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> someone = <span class="type">FamilyType</span>.<span class="type">Sister</span>(age: <span class="number">11</span>)</span><br><span class="line"><span class="keyword">let</span> somebody = <span class="type">FamilyType</span>.<span class="type">Mother</span>(age: <span class="number">40</span>)</span><br><span class="line"><span class="comment">// swift的枚举技巧</span></span><br><span class="line"><span class="keyword">let</span> someoneGift = someone.gift()     <span class="comment">// print toy</span></span><br><span class="line"><span class="keyword">let</span> somebodyGift = somebody.gift()	 <span class="comment">// book</span></span><br></pre></td></tr></table></figure>
<h4 id="那我们要取值的有">那我们要取值的有</h4><ul>
<li>方法一</li>
</ul>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> someone &#123;</span><br><span class="line"><span class="keyword">case</span> .Father(<span class="keyword">let</span> age):</span><br><span class="line">    age</span><br><span class="line"><span class="keyword">case</span> .Sister(<span class="keyword">let</span> age):</span><br><span class="line">    age</span><br><span class="line"><span class="annotation">default</span>:()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>方法二</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">case</span> .Sister(<span class="built_in">let</span> age) = someone &#123;</span><br><span class="line">    age</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="枚举的嵌套">枚举的嵌套</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> Colleague &#123;</span><br><span class="line">    <span class="keyword">enum</span> Weight: Int &#123;</span><br><span class="line">        <span class="keyword">case</span> Light</span><br><span class="line">        <span class="keyword">case</span> Mid</span><br><span class="line">        <span class="keyword">case</span> Heavy</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">case</span> iOS(weight: Weight)</span><br><span class="line">    <span class="keyword">case</span> Android(weight: Weight)</span><br><span class="line">    <span class="keyword">case</span> HTML(weight: Weight)</span><br><span class="line">&#125;</span><br><span class="line">let woodenHelmet = Colleague.iOS(weight: .Mid)</span><br></pre></td></tr></table></figure>
<h3 id="枚举的成员变量">枚举的成员变量</h3><p>之前就一直想要使用枚举做到外部动态对枚举赋值储存操作，<br>那成员变量用法如下</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据自身赋值</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Device</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> iPad, iPhone</span><br><span class="line">    <span class="keyword">var</span> year: <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> <span class="keyword">self</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> iPhone: <span class="keyword">return</span> <span class="number">2007</span></span><br><span class="line">        <span class="keyword">case</span> iPad: <span class="keyword">return</span> <span class="number">2010</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// set get 方法对于枚举的成员变量是无效的，允许get调用但set不可执行</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">Story</span>, <span class="type">News</span></span><br><span class="line">    <span class="keyword">var</span> year: <span class="type">Int</span> &#123;</span><br><span class="line">        <span class="keyword">set</span>&#123;</span><br><span class="line">            year = newValue</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">get</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.year</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myIpad = <span class="type">Device</span>.iPad</span><br><span class="line">myIpad.year</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> storyBook = <span class="type">Book</span>.<span class="type">Story</span></span><br><span class="line"><span class="comment">//storyBook.year = 2010	 // set 方法此处报错</span></span><br><span class="line"><span class="comment">//storyBook.year			 // get 无效</span></span><br></pre></td></tr></table></figure>
<h3 id="初始化，感觉然并软">初始化，感觉然并软</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">AppleDevice</span> &#123;</span></span><br><span class="line">    <span class="keyword">case</span> iMac(<span class="string">price:</span>Int)</span><br><span class="line">    <span class="keyword">case</span> iPod(<span class="string">price:</span>Int)</span><br><span class="line">    <span class="keyword">case</span> iPhone(<span class="string">price:</span>Int)</span><br><span class="line">    init (<span class="string">costMoney:</span> Int) &#123;</span><br><span class="line">        <span class="keyword">if</span> costMoney &gt; <span class="number">10000</span> &#123;</span><br><span class="line">            self = .iMac(<span class="string">price:</span> costMoney)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> costMoney &gt; <span class="number">2500</span> &#123;</span><br><span class="line">            self = .iPhone(<span class="string">price:</span> costMoney)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            self = .iPod(<span class="string">price:</span> costMoney)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let myDevice = AppleDevice(<span class="string">costMoney:</span> <span class="number">6000</span>)</span><br></pre></td></tr></table></figure>
<h3 id="元组的使用">元组的使用</h3><p>多个参数的介入时，可以使用元组,此处常规使用报错暂时无法解决，<br>使用func函数赋值倒是没有出错。why？？</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">HumanHabit</span> &#123;</span></span><br><span class="line">    <span class="keyword">case</span> Reading</span><br><span class="line">    <span class="keyword">case</span> PlayGame</span><br><span class="line">    <span class="keyword">case</span> Traveling</span><br><span class="line">&#125;</span><br><span class="line">typealias HumanInfo = (<span class="string">age:</span> Int, <span class="string">name:</span> String, <span class="string">habit:</span> HumanHabit)</span><br><span class="line"></span><br><span class="line">func selectRAM(<span class="string">humanInfo:</span> HumanInfo) -&gt; HumanInfo &#123;<span class="keyword">return</span> (<span class="string">age:</span> <span class="number">32</span>, <span class="string">name:</span> humanInfo.name, <span class="string">habit:</span> humanInfo.habit)&#125;</span><br><span class="line">func selectCPU(<span class="string">humanInfo:</span> HumanInfo) -&gt; HumanInfo &#123;<span class="keyword">return</span> (<span class="string">age:</span> humanInfo.age, <span class="string">name:</span> <span class="string">"3.2GHZ"</span>, <span class="string">habit:</span> humanInfo.habit)&#125;</span><br><span class="line">func selectGPU(<span class="string">humanInfo:</span> HumanInfo) -&gt; HumanInfo &#123;<span class="keyword">return</span> (<span class="string">age:</span> humanInfo.age, <span class="string">name:</span> <span class="string">"3.2GHZ"</span>, <span class="string">habit:</span> .Reading)&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Desktop</span> &#123;</span></span><br><span class="line">    <span class="keyword">case</span> Cube(HumanInfo)</span><br><span class="line">    <span class="keyword">case</span> Tower(HumanInfo)</span><br><span class="line">    <span class="keyword">case</span> Rack(HumanInfo)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let aTower = Desktop.Tower(selectGPU(selectCPU(selectRAM((<span class="number">0</span>, <span class="string">""</span>, .Traveling) <span class="keyword">as</span> HumanInfo))))</span><br></pre></td></tr></table></figure>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-移动周分享-第53期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/29/移动周分享-第53期/" class="article-date">
  	<time datetime="2016-04-29T10:30:00.000Z" itemprop="datePublished">2016-04-29</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/29/移动周分享-第53期/">移动周分享-第53期</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="JSPatch初探_-_刘康">JSPatch初探 - 刘康</h2><h4 id="什么是JSPatch">什么是JSPatch</h4><p>JSPatch是一个开源项目，最初是腾讯@bang的个人项目，诞生于2015年5月。它能够使用JavaScript调用Objective-C的原生接口，从而动态植入代码来替换旧代码，以实现修复线上bug。</p>
<h4 id="JSPatch平台">JSPatch平台</h4><p>JSPatch 需要使用者有一个后台可以下发和管理脚本，并且需要处理传输安全等部署工作。如果自己搭建后台下发 JSPatch 脚本，可以直接使用 github 上的代码。JSPatch 平台提供了脚本后台托管，版本管理，保证传输安全等功能，无需搭建一个后台，无需关心部署操作，只需引入一个 SDK 即可立即使用 JSPatch。</p>
<h4 id="JSPatch实现原理">JSPatch实现原理</h4><h5 id="基本原理">基本原理</h5><p>Objective-C是动态语言，具有运行时特性，该特性可通过类名称和方法名的字符串获取该类和该方法，并实例化和调用：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Class <span class="class"><span class="keyword">class</span> = <span class="title">NSClassFromString</span></span>(@<span class="string">"DataManager"</span>);</span><br><span class="line">id dataManager = [[<span class="class"><span class="keyword">class</span> <span class="title">alloc</span>] <span class="title">init</span>];</span></span><br><span class="line">SEL selector = NSSelectorFromString(@<span class="string">"saveData"</span>);</span><br><span class="line">[dataManager performSelector:selector];</span><br></pre></td></tr></table></figure>
<p>也可以替换某个类的方法为新的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mySaveData</span><span class="params">(id slf, SEL sel)</span> </span>&#123; &#125;</span><br><span class="line">class_replaceMethod(<span class="keyword">class</span>, selector, mySaveData, <span class="string">""</span>);</span><br></pre></td></tr></table></figure>
<p>新注册一个类，为类添加方法：</p>
<figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class cls = objc_allocateClassPair<span class="list">([NSObject class], <span class="string">"MyObject"</span>, <span class="number">0</span>)</span><span class="comment">;</span></span><br><span class="line">objc_registerClassPair<span class="list">(<span class="keyword">cls</span>)</span><span class="comment">;</span></span><br><span class="line">class_addMethod<span class="list">(<span class="keyword">cls</span>, selector, implement, typedesc)</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<h5 id="Javascript调用">Javascript调用</h5><p>可以用Javascript对象定义一个Objective-C类：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attribute">__isCls</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attribute">__clsName</span>: <span class="string">"UIView"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在OC执行JS脚本前，通过正则把所有方法调用都改成调用 __c() 函数，再执行这个JS脚本，做到了消息转发机制：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UIView.<span class="function"><span class="title">alloc</span><span class="params">()</span></span>.<span class="function"><span class="title">init</span><span class="params">()</span></span></span><br><span class="line">-&gt;</span><br><span class="line">UIView.__c(<span class="string">'alloc'</span>)().__c(<span class="string">'init'</span>)()</span><br></pre></td></tr></table></figure>
<h5 id="互传消息">互传消息</h5><ul>
<li><code>JavaScriptCore</code>: 通过此framework实现消息互传</li>
<li><code>JSContext</code>: JS代码的执行环境。JS通过调用 JSContext 定义的方法把数据传给OC，OC通过返回值传会给JS。</li>
</ul>
<h4 id="集成步骤">集成步骤</h4><p>通过JSPatch平台。</p>
<ul>
<li>创建App，获得AppKey</li>
<li>下载SDK并导入到项目</li>
<li>设置App Transport Security Settings</li>
<li>添加依赖框架：<code>libz.dylib</code>和<code>JavaScriptCore.framework</code></li>
<li>添加代码：</li>
</ul>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr_selector">[JSPatch startWithAppKey:@"c08857f72a4e5f7b"]</span>;</span><br><span class="line"><span class="attr_selector">[JSPatch sync]</span>; <span class="comment">//检查更新</span></span><br></pre></td></tr></table></figure>
<h4 id="如何使用">如何使用</h4><p>在 JSPatch 平台的规范里，JS脚本的文件名必须是 <code>main.js</code>。<br>直接在main.js中添加JavaScript代码！<br>详细使用请见<code>Github Wiki</code></p>
<h4 id="测试">测试</h4><ul>
<li>在项目中添加<code>main.js</code>文件</li>
<li>添加代码</li>
<li><code>didFinishLaunchingWithOptions</code>添加一行：</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[JSPatch testScriptInBundle]</span><span class="comment">;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Run!</li>
</ul>
<h4 id="在平台中添加JS脚本">在平台中添加JS脚本</h4><ol>
<li>在创建的应用中添加版本</li>
<li>在添加的版本中上传<code>main.js</code><br>上传后，对应版本的App会请求下载此 脚本并保存在本地，以后App每次启动都会执行。<br>亲测第一次并不会执行！！！</li>
</ol>
<h4 id="部署安全策略">部署安全策略</h4><p>使用 JSPatch 有两个安全问题：</p>
<ul>
<li>传输安全：JS 脚本可以调用任意 OC 方法，权限非常大，若被中间人攻击替换代码，会造成较大的危害。</li>
<li>执行安全：下发的 JS 脚本灵活度大，相当于一次小型更新，若未进行充分测试，可能会出现 crash 等情况对 APP 稳定性造成影响。</li>
</ul>
<p>针对传输安全问题，作者的建议是对下发的JS代码进行RSA校验，而执行安全，除了在发布JS脚本之前做好周全测试之外，还需要建立回退机制，实现方式是后台下发命令，让 APP 在下次启动时不执行 JSPatch 脚本即可。但这里能回退的前提是 APP 可以接收到后台下发的回退命令，若因为下发的脚本导致 APP 启动即时 crash，这个回退命令也会接收不到。所以建议再加一层防启动 crash 的机制，APP 在连续启动即 crash 后，下次启动不再执行脚本文件。</p>
<h4 id="Swift项目中使用JSPatch">Swift项目中使用JSPatch</h4><p>使用 <code>defineClass()</code> 覆盖 Swift 类时，类名应为 <code>项目名.原类名</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">defineClass</span><span class="params">(<span class="string">'demo.ViewController'</span>, &#123;&#125;)</span></span></span><br></pre></td></tr></table></figure>
<p>需要注意的是：</p>
<ol>
<li>只支持调用继承自 NSObject 的 Swift 类；</li>
<li>继承自 NSObject 的 Swift 类，其继承自父类的方法和属性可以在 JS 调用，其他自定义方法和属性同样需要加 dynamic 关键字才行；</li>
<li>若方法的参数/属性类型为 Swift 特有的(如 Character / Tuple)，则此方法和属性无法通过 JS 调用。</li>
</ol>
<h4 id="不会JavaScript?">不会JavaScript?</h4><p><a href="http://bang590.github.io/JSPatchConvertor/" target="_blank" rel="external">JSPatch Convertor</a></p>
<hr>
<p>参考：</p>
<p><a href="http://jspatch.com" target="_blank" rel="external">JSPatch平台</a></p>
<p><a href="https://github.com/bang590/JSPatch/wiki" target="_blank" rel="external">Github Wiki</a></p>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
    <article id="post-移动周分享-第52期" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/22/移动周分享-第52期/" class="article-date">
  	<time datetime="2016-04-22T10:30:00.000Z" itemprop="datePublished">2016-04-22</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/04/22/移动周分享-第52期/">移动周分享-第52期</a>
    </h1>
  

      </header>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Swift_的_Playground_学习">Swift 的 Playground 学习</h2><blockquote>
<p>我们一开始知道 <strong><em>Playground</em></strong>，也知道然后查看一些变量及变量的历史记录。偶尔还知道可以做视图甚至动画展示但是，现在，你特么看到的是 <strong><em>MarkDown</em></strong> 语法，有没有。</p>
</blockquote>
<h3 id="参考文献">参考文献</h3><ul>
<li><a href="http://nshipster.cn/xcplayground/" target="_blank" rel="external">XCPlayground介绍&amp;实践</a></li>
<li><a href="https://developer.apple.com/library/mac/documentation/Miscellaneous/Reference/XCPlaygroundModuleRef/XCPlayground.html" target="_blank" rel="external">XCPlayground苹果官网文档</a></li>
</ul>
<h3 id="使用优势">使用优势</h3><ul>
<li>快速学习swift</li>
<li>快速测试代码效果</li>
<li>验证API</li>
<li>富文本注释</li>
</ul>
<p><code>如下所有案例使用Xcode7下加载playground文件，可预览效果</code><br><a href="https://github.com/51offer/51offer.github.com/tree/blog/share_files/xcodeyang52.playground" target="_blank" rel="external">文件下载链接</a></p>
<h3 id="变量">变量</h3><blockquote>
<p>至上而下执行，显示变量的当前值及历史记录的变化。</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable"><span class="keyword">var</span> name</span> = <span class="string">"杨志"</span></span><br><span class="line">name += <span class="string">"平"</span></span><br><span class="line"><span class="comment">// playground下预览</span></span><br><span class="line"></span><br><span class="line"><span class="variable"><span class="keyword">var</span> graph</span> = <span class="number">0.0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0.</span>..<span class="number">100</span> &#123;</span><br><span class="line">    graph = sin(<span class="typename">Double</span>(i)/<span class="number">10.0</span>)</span><br><span class="line">    <span class="comment">// playground下预览</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="UI视图">UI视图</h3><blockquote>
<p>简单显示UI的基础元素</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">let redView = <span class="function"><span class="title">UIView</span><span class="params">(frame:CGRectMake(<span class="number">0</span>,<span class="number">0</span>,<span class="number">100</span>,<span class="number">100</span>)</span></span>)</span><br><span class="line">redView<span class="class">.backgroundColor</span> = UIColor.<span class="function"><span class="title">redColor</span><span class="params">()</span></span></span><br><span class="line">redView<span class="class">.layer</span><span class="class">.cornerRadius</span> = <span class="number">20</span></span><br><span class="line">redView<span class="class">.layer</span><span class="class">.borderWidth</span> = <span class="number">3</span></span><br><span class="line">redView<span class="class">.layer</span><span class="class">.borderColor</span> = UIColor.<span class="function"><span class="title">whiteColor</span><span class="params">()</span></span><span class="class">.CGColor</span></span><br><span class="line"></span><br><span class="line">let circle = <span class="function"><span class="title">UIView</span><span class="params">(frame:CGRectMake(<span class="number">25</span>,<span class="number">25</span>,<span class="number">50</span>,<span class="number">50</span>)</span></span>)</span><br><span class="line">circle<span class="class">.backgroundColor</span> = UIColor.<span class="function"><span class="title">yellowColor</span><span class="params">()</span></span></span><br><span class="line">circle<span class="class">.layer</span><span class="class">.cornerRadius</span> = <span class="number">80</span></span><br><span class="line">redView.<span class="function"><span class="title">addSubview</span><span class="params">(circle)</span></span></span><br><span class="line"><span class="comment">// playground下预览</span></span><br></pre></td></tr></table></figure>
<h3 id="重头戏">重头戏</h3><h4 id="动画展示_&amp;_网络请求">动画展示 &amp; 网络请求</h4><blockquote>
<p>这里需要对 XCPlayground 有一点了解，好像还对SpriteKit做了支持<a href="http://letvar.com/blog/2014/06/swift-and-playgrounds-learn-to-program-in-a-fun-way-2/" target="_blank" rel="external">文章连接</a></p>
</blockquote>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个库需要import</span></span><br><span class="line"><span class="built_in">import</span> XCPlayground</span><br><span class="line"></span><br><span class="line"><span class="built_in">let</span> containerView = UIView<span class="params">(frame: CGRect<span class="params">(x: <span class="number">0</span>, y: <span class="number">0</span>, width: <span class="number">320</span>, height: <span class="number">480</span>)</span>)</span></span><br><span class="line">containerView.backgroundColor = UIColor.yellowColor<span class="params">()</span></span><br><span class="line">XCPlaygroundPage.currentPage.liveView = containerView</span><br><span class="line"></span><br><span class="line"><span class="built_in">let</span> view = UIView<span class="params">(frame: CGRect<span class="params">(x: <span class="number">0</span>, y: <span class="number">0</span>, width: <span class="number">100</span>, height: <span class="number">100</span>)</span>)</span></span><br><span class="line">view.center = CGPoint<span class="params">(x: containerView.center.x, y: containerView.center.y-<span class="number">100</span>)</span></span><br><span class="line">view.backgroundColor = UIColor.redColor<span class="params">()</span></span><br><span class="line">containerView.addSubview<span class="params">(view)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// playground下预览</span></span><br><span class="line">UIView.animateWithDuration<span class="params">(<span class="number">3</span>, delay: <span class="number">0</span>, usingSpringWithDamping: <span class="number">0.1</span>, initialSpringVelocity: <span class="number">6</span>, options: UIViewAnimationOptions.CurveEaseInOut, animations: &#123;</span><br><span class="line">        view.center.y += <span class="number">100</span></span><br><span class="line">    &#125;, completion:&#123; <span class="params">(animation: Bool)</span> in</span><br><span class="line">        view.center.y -= <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 异步操作：网络在家图片</span></span><br><span class="line"><span class="comment">// 旧接口：XCPSetExecutionShouldContinueIndefinitely(true)</span></span><br><span class="line">XCPlaygroundPage.currentPage.needsIndefiniteExecution = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">let</span> url = NSURL<span class="params">(string: <span class="string">"https://avatars1.githubusercontent.com/u/5317671?v=3&amp;s=460"</span>)</span><span class="built_in">!</span></span><br><span class="line"><span class="built_in">let</span> task = NSURLSession.sharedSession<span class="params">()</span>.dataTaskWithURL<span class="params">(url)</span> &#123;</span><br><span class="line">    data, _, _ in</span><br><span class="line">    <span class="built_in">let</span> image = UIImage<span class="params">(data: data!)</span></span><br><span class="line">    <span class="comment">// playground下预览</span></span><br><span class="line">&#125;</span><br><span class="line">task.resume<span class="params">()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 快速检查API接口</span></span><br><span class="line"><span class="built_in">let</span> url2 = NSURL<span class="params">(string: <span class="string">"http://www.test.51offer.com/mobile/abroad/query_school_by_name?name=%E4%B8%80"</span>)</span><span class="built_in">!</span></span><br><span class="line"><span class="built_in">let</span> task2 = NSURLSession.sharedSession<span class="params">()</span>.dataTaskWithURL<span class="params">(url2)</span> &#123;</span><br><span class="line">    data, _, _ in</span><br><span class="line">    <span class="built_in">let</span> <span class="built_in">str</span> = String<span class="params">(NSString<span class="params">(data: data!, encoding: NSUTF8StringEncoding)</span>)</span></span><br><span class="line">    <span class="comment">// playground下预览</span></span><br><span class="line">&#125;</span><br><span class="line">task2.resume<span class="params">()</span></span><br></pre></td></tr></table></figure>
<h3 id="结构介绍">结构介绍</h3><ul>
<li><p>sources</p>
<blockquote>
<p>我们直接在 Playground 上面写代码，然后编译器会实时编译我们代码，并将结果显示出来。但是效率很低，source的作用就可以发挥出来</p>
</blockquote>
</li>
<li><p>resources</p>
<blockquote>
<p>可以作为sandbox使用</p>
</blockquote>
</li>
</ul>
<figure class="highlight openscad"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 直接使用PicButton 这个class.</span></span><br><span class="line"><span class="comment">// 注意点：PicButton的类及初始化方法必须是public的</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">let</span> btn = PicButton<span class="params">(frame: CGRectMake<span class="params">(<span class="number">0</span>,<span class="number">0</span>,<span class="number">200</span>,<span class="number">100</span>)</span>)</span></span><br><span class="line"><span class="comment">// playground下预览</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如上述：在resources中放入jpg图片，加载本地资源</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">let</span> path = NSBundle.mainBundle<span class="params">()</span>.pathForResource<span class="params">(<span class="string">"swift-playground"</span>, ofType: <span class="string">"jpg"</span>)</span> &#123;</span><br><span class="line">    <span class="built_in">let</span> image = UIImage<span class="params">(contentsOfFile:path)</span></span><br><span class="line">    <span class="built_in">let</span> imageView = UIImageView<span class="params">(image: image)</span></span><br><span class="line">        <span class="comment">// playground下预览</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Android_APP开发设计模式_-_王胜">Android APP开发设计模式 - 王胜</h2><h3 id="MVC(Standard_Android)">MVC(Standard Android)</h3><ul>
<li><p>目录结构</p>
<p><img src="http://7xsk2b.com2.z0.glb.clouddn.com/image/android-mvc.png" alt="android-mvc"></p>
<ul>
<li><p>Weather</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Weather</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String date;<span class="comment">//日期</span></span><br><span class="line">    <span class="keyword">private</span> String textDay;<span class="comment">//白天天气</span></span><br><span class="line">    <span class="keyword">private</span> String textNight;<span class="comment">//夜晚天气</span></span><br><span class="line">    <span class="keyword">private</span> String high;<span class="comment">//最高气温</span></span><br><span class="line">    <span class="keyword">private</span> String low;<span class="comment">//最低气温</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getDisplay</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        sb.append(date);</span><br><span class="line">        sb.append(<span class="string">"\t"</span>);</span><br><span class="line">        sb.append(<span class="string">"白天:"</span>);</span><br><span class="line">        sb.append(textDay);</span><br><span class="line">        sb.append(<span class="string">", "</span>);</span><br><span class="line">        sb.append(<span class="string">"夜晚:"</span>);</span><br><span class="line">        sb.append(textNight);</span><br><span class="line">        sb.append(<span class="string">", "</span>);</span><br><span class="line">        sb.append(<span class="string">"最高气温:"</span>);</span><br><span class="line">        sb.append(high);</span><br><span class="line">        sb.append(<span class="string">", "</span>);</span><br><span class="line">        sb.append(<span class="string">"最低气温:"</span>);</span><br><span class="line">        sb.append(low);</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// setter and getter</span></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>WeatherActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line">   <span class="keyword">private</span> ListView lv;</span><br><span class="line">   <span class="keyword">private</span> LinearLayout llLoading;</span><br><span class="line"></span><br><span class="line">   <span class="annotation">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">       setContentView(R.layout.activity_weather);</span><br><span class="line">       lv = (ListView) findViewById(R.id.lv);</span><br><span class="line">       llLoading = (LinearLayout) findViewById(R.id.ll_loading);</span><br><span class="line">       loadData();</span><br><span class="line">   &#125;</span><br><span class="line">	</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       HttpEngine.get(Constants.API_WEATHER, <span class="keyword">new</span> HttpEngine.JSONRequestCallback() &#123;</span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailed</span><span class="params">(Call call, Exception e)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (call.request().url().url().toString().equals(Constants.API_WEATHER)) &#123;</span><br><span class="line">                   Log.e(WeatherActivity.class.getSimpleName(), e.getMessage());</span><br><span class="line">                   Toast.makeText(WeatherActivity.<span class="keyword">this</span>, <span class="string">"Get data failed!"</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">                   llLoading.setVisibility(View.GONE);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">	</span><br><span class="line">           <span class="annotation">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Call call, JSONObject jsonResult)</span> </span>&#123;</span><br><span class="line">               <span class="keyword">if</span> (call.request().url().url().toString().equals(Constants.API_WEATHER)) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       JSONArray jsonArray = jsonResult.getJSONArray(<span class="string">"results"</span>).getJSONObject(<span class="number">0</span>).getJSONArray(<span class="string">"daily"</span>);</span><br><span class="line">                       Gson gson = <span class="keyword">new</span> GsonBuilder().setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES).create();</span><br><span class="line">                       <span class="keyword">final</span> List&lt;Weather&gt; data = gson.fromJson(jsonArray.toString(), <span class="keyword">new</span> TypeToken&lt;List&lt;Weather&gt;&gt;()&#123;&#125;.getType());</span><br><span class="line">                       WeatherAdapter adapter = <span class="keyword">new</span> WeatherAdapter(WeatherActivity.<span class="keyword">this</span>, data);</span><br><span class="line">                       lv.setAdapter(adapter);</span><br><span class="line">                       llLoading.setVisibility(View.GONE);</span><br><span class="line">                       lv.setVisibility(View.VISIBLE);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">                       Log.e(WeatherActivity.class.getSimpleName(), e.getMessage());</span><br><span class="line">                       Toast.makeText(WeatherActivity.<span class="keyword">this</span>, <span class="string">"Get data failed!"</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="MVP">MVP</h3><ul>
<li><p>目录结构</p>
<p><img src="http://7xsk2b.com2.z0.glb.clouddn.com/image/android-mvp.png" alt="android-mvp"></p>
<ul>
<li>Weather 同上</li>
<li><p>IWeatherView &amp;&amp; WeatherActivity</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IWeatherView</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 刷新天气列表</span><br><span class="line">     * <span class="doctag">@param</span> data</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">refreshWeatherList</span><span class="params">(List&lt;Weather&gt; data)</span></span>;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 显示错误信息</span><br><span class="line">     * <span class="doctag">@param</span> e</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">showErrorInfo</span><span class="params">(Exception e)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">IWeatherView</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ListView lv;</span><br><span class="line">    <span class="keyword">private</span> LinearLayout llLoading;</span><br><span class="line">    <span class="keyword">private</span> WeatherPresenter mWeatherPresenter;</span><br><span class="line">	</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_weather);</span><br><span class="line">        lv = (ListView) findViewById(R.id.lv);</span><br><span class="line">        llLoading = (LinearLayout) findViewById(R.id.ll_loading);</span><br><span class="line">        mWeatherPresenter = <span class="keyword">new</span> WeatherPresenter(<span class="keyword">this</span>);</span><br><span class="line">        mWeatherPresenter.getWeatherList();</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshWeatherList</span><span class="params">(List&lt;Weather&gt; data)</span> </span>&#123;</span><br><span class="line">        WeatherAdapter adapter = <span class="keyword">new</span> WeatherAdapter(WeatherActivity.<span class="keyword">this</span>, data);</span><br><span class="line">        lv.setAdapter(adapter);</span><br><span class="line">        llLoading.setVisibility(View.GONE);</span><br><span class="line">        lv.setVisibility(View.VISIBLE);</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="annotation">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showErrorInfo</span><span class="params">(Exception e)</span> </span>&#123;</span><br><span class="line">        Log.e(WeatherActivity.class.getSimpleName(), e.getMessage());</span><br><span class="line">        Toast.makeText(WeatherActivity.<span class="keyword">this</span>, <span class="string">"Get data failed!"</span>, Toast.LENGTH_LONG).show();</span><br><span class="line">        llLoading.setVisibility(View.GONE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>WeatherPresenter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherPresenter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IWeatherView mWeatherView;</span><br><span class="line">	</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WeatherPresenter</span><span class="params">(@NonNull IWeatherView view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mWeatherView = view;</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * 通过网络请求获取天气列表数据</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getWeatherList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        HttpEngine.get(Constants.API_WEATHER, <span class="keyword">new</span> HttpEngine.JSONRequestCallback() &#123;</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailed</span><span class="params">(Call call, Exception e)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (call.request().url().url().toString().equals(Constants.API_WEATHER)) &#123;</span><br><span class="line">                    mWeatherView.showErrorInfo(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">	</span><br><span class="line">            <span class="annotation">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">(Call call, JSONObject jsonResult)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (call.request().url().url().toString().equals(Constants.API_WEATHER)) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        JSONArray jsonArray = jsonResult.getJSONArray(<span class="string">"results"</span>).getJSONObject(<span class="number">0</span>).getJSONArray(<span class="string">"daily"</span>);</span><br><span class="line">                        Gson gson = <span class="keyword">new</span> GsonBuilder().setFieldNamingPolicy(FieldNamingPolicy.LOWER_CASE_WITH_UNDERSCORES).create();</span><br><span class="line">                        List&lt;Weather&gt; data = gson.fromJson(jsonArray.toString(), <span class="keyword">new</span> TypeToken&lt;List&lt;Weather&gt;&gt;()&#123;&#125;.getType());</span><br><span class="line">                        mWeatherView.refreshWeatherList(data);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">                        mWeatherView.showErrorInfo(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>

      
    </div>
    
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Playground/">Playground</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/移动组周技术分享/">移动组周技术分享</a>
	</div>


      
      <div class="clearfix"></div>
    </div>
    
  </div>
  
</article>







  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 移动组团队
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>